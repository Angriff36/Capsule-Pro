#!/usr/bin/env sh
set -e

# Block pushes if any Vercel-deployed app fails its build
# Mirrors per-app vercel.json buildCommand behavior

# Install workspace deps to ensure builds run like Vercel
pnpm -s install --frozen-lockfile

# Ensure BaseHub token is available for the web build.
# Load from apps/web/.env.local if not already exported.
if [ -z "$BASEHUB_TOKEN" ] && [ -f "apps/web/.env.local" ]; then
  BASEHUB_TOKEN=$(grep -E '^BASEHUB_TOKEN=' apps/web/.env.local | head -n 1 | cut -d '=' -f2- | sed -e 's/^"//' -e 's/"$//')
  export BASEHUB_TOKEN
fi

if [ -z "$BASEHUB_TOKEN" ]; then
  echo "BASEHUB_TOKEN is not set. Add it to apps/web/.env.local or export it before pushing."
  exit 1
fi

# Build apps in the same way Vercel does
pnpm -s --filter api build
pnpm -s --filter app build
pnpm -s --filter web build
# Docs optional: enable if deployed via Vercel
pnpm -s --filter docs build

# Secrets scan must pass
pnpm -s run secrets:scan
