# Migration: Add Foreign Key Constraints (20260129120000)

## Overview

**Migration ID:** `20260129120000_add_foreign_keys`
**Date:** 2025-01-29
**Purpose:** Add database-level foreign key constraints to enforce referential integrity across all tenant schemas

## Summary

This migration adds **108 foreign key constraints** across **8 schemas** to enforce referential integrity at the database level. All constraints are added with idempotent `DO $$ blocks` that check for existence before creation.

### Total Constraints by Schema

| Schema | Constraint Count | Tables Affected |
|--------|-----------------|-----------------|
| `tenant_crm` | 11 | 8 tables |
| `tenant_events` | 26 | 13 tables |
| `tenant_inventory` | 16 | 9 tables |
| `tenant_kitchen` | 37 | 21 tables |
| `tenant_staff` | 27 | 16 tables |
| `tenant` | 2 | 1 table |
| `tenant_admin` | 11 | 5 tables |
| **Total** | **108** | **73 tables** |

### ON DELETE Behavior Distribution

| Behavior | Count | Usage |
|----------|-------|-------|
| `CASCADE` | 47 | Child records deleted when parent deleted (composition relationships) |
| `SET NULL` | 39 | Child records lose reference (optional relationships) |
| `RESTRICT` | 22 | Parent cannot be deleted if children exist (critical entities) |

## Schema Details

### tenant_crm (11 constraints)

**CASCADE (5):**
- `client_contacts.client_id` → `clients(id)`
- `client_preferences.client_id` → `clients(id)`
- `proposal_line_items.proposal_id` → `proposals(id)`

**SET NULL (5):**
- `client_interactions.client_id` → `clients(id)`
- `client_interactions.lead_id` → `leads(id)`
- `clients.assigned_to` → `employees(id)`
- `leads.assigned_to` → `employees(id)`
- `leads.converted_to_client_id` → `clients(id)`
- `proposals.client_id` → `clients(id)`
- `proposals.lead_id` → `leads(id)`
- `proposals.event_id` → `events(id)`

**RESTRICT (1):**
- `client_interactions.employee_id` → `employees(id)`

### tenant_events (26 constraints)

**CASCADE (13):**
- `budget_line_items.budget_id` → `event_budgets(id)`
- `command_board_cards.board_id` → `command_boards(id)`
- `contract_signatures.contract_id` → `event_contracts(id)`
- `event_budgets.event_id` → `events(id)`
- `event_contracts.event_id` → `events(id)`
- `event_dishes.event_id` → `events(id)`
- `event_guests.event_id` → `events(id)`
- `event_imports.event_id` → `events(id)`
- `event_profitability.event_id` → `events(id)`
- `event_staff_assignments.event_id` → `events(id)`
- `event_summaries.event_id` → `events(id)`
- `event_timeline.event_id` → `events(id)`
- `timeline_tasks.event_id` → `events(id)`

**SET NULL (9):**
- `battle_boards.event_id` → `events(id)`
- `catering_orders.event_id` → `events(id)`
- `command_boards.event_id` → `events(id)`
- `events.client_id` → `clients(id)`
- `events.location_id` → `locations(id)`
- `events.assigned_to` → `employees(id)`
- `events.venue_id` → `locations(id)`
- `timeline_tasks.assignee_id` → `employees(id)`
- `shipments.event_id` → `events(id)`

**RESTRICT (4):**
- `catering_orders.customer_id` → `clients(id)`
- `event_contracts.client_id` → `clients(id)`
- `event_dishes.dish_id` → `dishes(id)`
- `event_staff_assignments.employee_id` → `employees(id)`

### tenant_inventory (16 constraints)

**CASCADE (6):**
- `inventory_alerts.item_id` → `inventory_items(id)`
- `purchase_order_items.purchase_order_id` → `purchase_orders(id)`
- `shipment_items.shipment_id` → `shipments(id)`
- `storage_locations.location_id` → `locations(id)`
- `task_bundle_items.bundle_id` → `task_bundles(id)`
- `task_claims.task_id` → `kitchen_tasks(id)`
- `task_progress.task_id` → `kitchen_tasks(id)`

**SET NULL (5):**
- `inventory_transactions.storage_location_id` → `storage_locations(id)`
- `shipments.event_id` → `events(id)`
- `shipments.supplier_id` → `inventory_suppliers(id)`
- `shipments.location_id` → `locations(id)`

**RESTRICT (8):**
- `inventory_stock.item_id` → `inventory_items(id)`
- `inventory_stock.storage_location_id` → `storage_locations(id)`
- `inventory_transactions.item_id` → `inventory_items(id)`
- `purchase_order_items.item_id` → `inventory_items(id)`
- `purchase_orders.vendor_id` → `inventory_suppliers(id)`
- `purchase_orders.location_id` → `locations(id)`
- `shipment_items.item_id` → `inventory_items(id)`

### tenant_kitchen (37 constraints)

**CASCADE (12):**
- `allergen_warnings.event_id` → `events(id)`
- `menu_dishes.menu_id` → `menus(id)`
- `prep_comments.task_id` → `kitchen_tasks(id)`
- `prep_list_items.prep_list_id` → `prep_lists(id)`
- `prep_lists.event_id` → `events(id)`
- `prep_tasks.event_id` → `events(id)`
- `recipe_ingredients.recipe_version_id` → `recipe_versions(id)`
- `recipe_steps.recipe_version_id` → `recipe_versions(id)`
- `recipe_versions.recipe_id` → `recipes(id)`
- `task_bundle_items.bundle_id` → `task_bundles(id)`
- `task_claims.task_id` → `kitchen_tasks(id)`
- `task_progress.task_id` → `kitchen_tasks(id)`

**SET NULL (17):**
- `allergen_warnings.dish_id` → `dishes(id)`
- `allergen_warnings.acknowledged_by` → `employees(id)`
- `containers.location_id` → `storage_locations(id)`
- `dishes.default_container_id` → `containers(id)`
- `prep_comments.resolved_by` → `employees(id)`
- `prep_list_items.dish_id` → `dishes(id)`
- `prep_list_items.recipe_version_id` → `recipe_versions(id)`
- `prep_list_items.completed_by` → `employees(id)`
- `prep_tasks.dish_id` → `dishes(id)`
- `prep_tasks.recipe_version_id` → `recipe_versions(id)`
- `prep_tasks.method_id` → `prep_methods(id)`
- `prep_tasks.container_id` → `containers(id)`
- `prep_tasks.import_id` → `prep_list_imports(id)`
- `recipe_versions.locked_by` → `employees(id)`
- `task_bundles.event_id` → `events(id)`
- `waste_entries.location_id` → `storage_locations(id)`
- `waste_entries.event_id` → `events(id)`

**RESTRICT (8):**
- `dishes.recipe_id` → `recipes(id)`
- `menu_dishes.dish_id` → `dishes(id)`
- `prep_comments.employee_id` → `employees(id)`
- `prep_list_items.ingredient_id` → `ingredients(id)`
- `prep_tasks.location_id` → `storage_locations(id)`
- `recipe_ingredients.ingredient_id` → `ingredients(id)`
- `task_bundle_items.task_id` → `kitchen_tasks(id)`
- `task_claims.employee_id` → `employees(id)`
- `task_progress.employee_id` → `employees(id)`
- `waste_entries.inventory_item_id` → `inventory_items(id)`
- `waste_entries.logged_by` → `employees(id)`

### tenant_staff (27 constraints)

**CASCADE (10):**
- `budget_alerts.budget_id` → `labor_budgets(id)`
- `employee_availability.employee_id` → `employees(id)`
- `employee_certifications.employee_id` → `employees(id)`
- `employee_locations.employee_id` → `employees(id)`
- `employee_locations.location_id` → `locations(id)`
- `employee_seniority.employee_id` → `employees(id)`
- `employee_skills.employee_id` → `employees(id)`
- `open_shifts.schedule_id` → `schedules(id)`
- `payroll_line_items.payroll_run_id` → `payroll_runs(id)`
- `schedule_shifts.schedule_id` → `schedules(id)`
- `timecard_edit_requests.time_entry_id` → `time_entries(id)`

**SET NULL (10):**
- `budget_alerts.acknowledged_by` → `employees(id)`
- `employee_skills.verified_by` → `employees(id)`
- `labor_budgets.location_id` → `locations(id)`
- `labor_budgets.event_id` → `events(id)`
- `open_shifts.claimed_by` → `employees(id)`
- `open_shifts.assigned_shift_id` → `schedule_shifts(id)`
- `payroll_runs.approved_by` → `employees(id)`
- `schedules.location_id` → `locations(id)`
- `schedules.published_by` → `employees(id)`
- `time_entries.location_id` → `locations(id)`
- `time_entries.shift_id` → `schedule_shifts(id)`
- `time_entries.approved_by` → `employees(id)`

**RESTRICT (7):**
- `employee_skills.skill_id` → `skills(id)`
- `open_shifts.location_id` → `locations(id)`
- `payroll_line_items.employee_id` → `employees(id)`
- `payroll_runs.payroll_period_id` → `payroll_periods(id)`
- `schedule_shifts.employee_id` → `employees(id)`
- `schedule_shifts.location_id` → `locations(id)`
- `time_entries.employee_id` → `employees(id)`
- `timecard_edit_requests.employee_id` → `employees(id)`

### tenant (2 constraints)

**SET NULL (2):**
- `documents.event_id` → `events(id)`
- `documents.battle_board_id` → `battle_boards(id)`

### tenant_admin (11 constraints)

**CASCADE (4):**
- `notifications.recipient_employee_id` → `employees(id)`
- `report_history.report_id` → `reports(id)`
- `report_schedules.report_id` → `reports(id)`
- `workflow_steps.workflow_id` → `workflows(id)`

**SET NULL (7):**
- `report_history.schedule_id` → `report_schedules(id)`
- `report_history.generated_by` → `employees(id)`
- `reports.created_by` → `employees(id)`
- `workflow_executions.triggered_by` → `employees(id)`
- `workflow_executions.current_step_id` → `workflow_steps(id)`
- `workflow_steps.on_success_step_id` → `workflow_steps(id)`
- `workflow_steps.on_failure_step_id` → `workflow_steps(id)`

**RESTRICT (2):**
- `workflow_executions.workflow_id` → `workflows(id)`

## Key Design Patterns

### 1. Composite Foreign Keys
Most foreign keys use composite references `(tenant_id, id)` to maintain tenant isolation:
```sql
FOREIGN KEY (tenant_id, client_id)
REFERENCES tenant_crm.clients(tenant_id, id)
```

### 2. Cross-Schema References
Many constraints reference tables in other schemas:
- `tenant_crm.clients` ← referenced by `tenant_events`, `tenant_kitchen`
- `tenant_events.events` ← referenced by all domain schemas
- `tenant_staff.employees` ← referenced by all domain schemas
- `tenant.locations` ← referenced by `tenant_events`, `tenant_inventory`, `tenant_staff`

### 3. ON DELETE Behavior Rationale

**CASCADE:** Used when child records are compositionally owned by the parent
- Line items → parent documents
- Comments/tasks → parent entities
- Assignments → parent entity

**SET NULL:** Used for optional relationships where child should survive parent deletion
- Assignee references (employees can be reassigned)
- Event/location references (soft unlinking)
- Parent references in hierarchies

**RESTRICT:** Used when parent deletion would break business logic
- Employee references in critical records (time entries, payroll)
- Inventory items in transactions
- Critical business relationships

## Migration Safety

The migration uses **idempotent pattern** with existence checks:
```sql
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'fk_name'
        AND table_schema = 'schema_name'
    ) THEN
        ALTER TABLE schema_name.table
        ADD CONSTRAINT fk_name
        FOREIGN KEY (columns)
        REFERENCES parent_table(columns)
        ON DELETE behavior;
    END IF;
END $$;
```

This ensures:
- Safe re-run if migration fails partway through
- No errors if constraints already exist
- Idempotent execution in deployment pipelines

## Impact

### Data Integrity
- **Enforces referential integrity** at database level
- **Prevents orphaned records** across all tenant schemas
- **Enforces business rules** through ON DELETE behaviors

### Performance
- **Index usage:** Foreign keys automatically use existing indexes
- **Query optimization:** Database can optimize joins knowing relationships are enforced
- **Cascade operations:** Database handles cascades more efficiently than application code

### Application Code
- **Can remove application-level checks** for FK violations
- **Simplifies deletion logic** (cascades handled by DB)
- **Provides better error messages** for constraint violations

## Rollback

To rollback this migration, drop all foreign key constraints:
```sql
-- Example pattern (repeat for each constraint)
ALTER TABLE schema_name.table
DROP CONSTRAINT IF EXISTS fk_constraint_name;
```

**Note:** Rollback should be done with caution as it removes data integrity safeguards.

## Related Migrations

- **Previous:** Schema setup migrations creating tables without FKs
- **Next:** Index optimizations for FK performance
- **See also:** `docs/legacy-contracts/schema-contract-v2.txt` for FK patterns
