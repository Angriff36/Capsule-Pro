# Migration 0000_init

## Date
N/A (Initial migration)

## Description
Initial database schema creation - establishes the complete multi-tenant catering management system foundation.

## Changes

### Extensions
- `uuid-ossp`: Provides UUID generation functions (`uuid_generate_v4()`)
- `pgcrypto`: Provides cryptographic functions including `gen_random_uuid()` for UUID generation

### Schemas Created
- **core**: Shared enums, functions, and core reference data
- **platform**: Platform-level tables (no tenant isolation)
- **public**: Core shared models (Tenant, OutboxEvent)
- **auth**: Authentication functions (stub `auth.jwt()` for RLS policies)
- **tenant**: Tenant-scoped shared tables (locations, documents, settings)
- **tenant_admin**: Admin, reporting, workflow, notification tables
- **tenant_crm**: Client management, leads, proposals, interactions
- **tenant_events**: Events, battle boards, command boards, contracts
- **tenant_inventory**: Inventory management, suppliers, cycle counting
- **tenant_kitchen**: Kitchen tasks, recipes, prep lists, waste tracking
- **tenant_staff**: Employees, scheduling, time tracking, payroll

### Core Functions
- `core.fn_update_timestamp()`: Auto-updates `updated_at` timestamp on row updates
- `core.fn_prevent_tenant_mutation()`: Prevents changes to `tenant_id` after row creation

### Enums Created
- `core.action_type`: insert, update, delete
- `core.employment_type`: full_time, part_time, contractor, temp
- `core.unit_system`: metric, imperial, custom
- `core.unit_type`: volume, weight, count, length, temperature, time
- `KitchenTaskPriority`: low, medium, high, urgent
- `KitchenTaskStatus`: open, in_progress, done, canceled
- `OutboxStatus`: pending, published, failed
- `UserRole`: owner, admin, manager, staff
- `tenant_admin.admin_action`: Login, logout, create, update, delete, etc.
- `tenant_admin.admin_entity_type`: admin_users, admin_roles, permissions, etc.
- `tenant_admin.admin_role`: super_admin, tenant_admin, finance_manager, etc.

### Key Tables by Schema

#### platform (no tenant_id)
- `accounts`: Platform account/organization configuration
- `audit_log`: Cross-tenant audit trail
- `audit_archive`: Archived audit records
- `sent_emails`: Email tracking across platform

#### public (shared)
- `Tenant`: Tenant registry
- `OutboxEvent`: Outbox pattern for real-time events (Ably integration)

#### tenant
- `locations`: Physical business locations
- `documents`: Document storage (parsed battle boards, contracts)
- `settings`: Tenant-scoped configuration

#### tenant_staff
- `employees`: Employee master records
- `employee_locations`: Employee-location assignments
- `employee_seniority`: Seniority/rank tracking
- `schedules`: Shift schedules
- `schedule_shifts`: Individual shift assignments
- `time_entries`: Time clock punches
- `timecard_edit_requests`: Timecard correction workflow
- `open_shifts`: Open shifts for claiming
- `skills`: Employee skills registry
- `employee_skills`: Skill proficiency tracking
- `employee_certifications`: Certification tracking
- `employee_availability`: Availability preferences
- `payroll_periods`: Payroll period definitions
- `payroll_runs`: Payroll processing runs
- `payroll_line_items`: Individual payroll calculations

#### tenant_kitchen
- `kitchen_tasks`: Generic kitchen tasks
- `prep_tasks`: Event-specific prep tasks
- `task_claims`: Task assignment claims
- `task_progress`: Task progress updates
- `prep_lists`: Generated prep lists
- `prep_list_items`: Individual prep list items
- `prep_comments`: Task comments/discussion
- `prep_list_imports`: External system imports
- `task_bundles`: Task groupings
- `task_bundle_items`: Bundle-to-task relationships
- `recipes`: Recipe definitions
- `recipe_versions`: Recipe version control
- `recipe_ingredients`: Recipe ingredient line items
- `recipe_steps`: Recipe preparation steps
- `ingredients`: Ingredient master
- `dishes`: Dish/menu item definitions
- `prep_methods`: Preparation technique catalog
- `method_videos`: Training videos for prep methods
- `containers`: Storage container catalog
- `allergen_warnings`: Allergen detection alerts
- `waste_entries`: Waste tracking logs

#### tenant_events
- `events`: Event master records
- `event_profitability`: Budget vs actual financial tracking
- `event_summaries`: AI-generated event summaries
- `event_staff_assignments`: Employee event assignments
- `event_timeline`: Event timeline/milestones
- `event_imports`: Imported event documents (TPP PDF, CSV)
- `event_dishes`: Menu items per event
- `event_guests`: Guest lists with dietary restrictions
- `event_contracts`: Contract management
- `contract_signatures`: Digital signature tracking
- `battle_boards`: Battle board JSON storage
- `command_boards`: Command board kanban
- `command_board_cards`: Individual cards on command boards
- `timeline_tasks`: Event timeline task management
- `catering_orders`: Catering order management

#### tenant_crm
- `clients`: Client companies (B2B) and individuals
- `client_contacts`: Contact persons at client companies
- `client_preferences`: Client-specific preferences
- `leads`: Sales leads pipeline
- `client_interactions`: Communication history
- `proposals`: Proposals/quotes
- `proposal_line_items`: Proposal line items

#### tenant_inventory
- `inventory_items`: Inventory item master
- `inventory_transactions`: Stock movement transactions
- `inventory_suppliers`: Supplier master
- `inventory_alerts`: Stock level alerts
- `inventory_stock`: Current stock by location
- `storage_locations`: Physical storage locations
- `inventory_forecasts`: Demand forecasting
- `forecast_inputs`: Forecast model inputs
- `reorder_suggestions`: Automated reorder recommendations
- `alerts_config`: Alert routing configuration
- `cycle_count_sessions`: Cycle count sessions
- `cycle_count_records`: Individual count records
- `variance_reports`: Variance analysis reports
- `cycle_count_audit_log`: Audit trail for counts
- `purchase_orders`: Purchase order management
- `purchase_order_items`: PO line items

#### tenant_admin
- `admin_users`: Administrative user accounts
- `admin_roles`: Role definitions
- `admin_permissions`: Permission registry
- `admin_audit_trail`: Admin action audit log
- `reports`: Custom report definitions
- `report_schedules`: Automated report schedules
- `report_history`: Report generation history
- `workflows`: Workflow automation definitions
- `workflow_steps`: Workflow step definitions
- `workflow_executions`: Workflow run history
- `notifications`: Notification queue
- `notification_preferences`: User notification preferences

#### core (reference data)
- `units`: Unit of measure definitions
- `unit_conversions`: Unit conversion factors
- `waste_reasons`: Waste reason codes
- `status_types`: Status code definitions
- `status_transitions`: Allowed status transitions
- `audit_config`: Audit trail configuration

## Design Patterns

### Multi-Tenancy
- All tenant-scoped tables include `tenant_id UUID NOT NULL`
- Composite primary keys: `(tenant_id, id)` for tenant tables
- Indexes always include `tenant_id` for query isolation

### Soft Deletes
- Tables include `deleted_at TIMESTAMPTZ` nullable column
- Soft delete pattern: `WHERE deleted_at IS NULL`
- Actual deletes prevented via RLS policies

### Audit Trail
- `created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP`
- `updated_at TIMESTAMPTZ` (auto-updated via trigger)
- `core.fn_update_timestamp()` trigger on all tables

### Timestamps
- All timestamps use `TIMESTAMPTZ(6)` (microsecond precision)
- Timezone-aware storage (UTC)
- Default timezone: `UTC` (accounts table)

### UUIDs
- Primary keys use `gen_random_uuid()` (from pgcrypto)
- Some tables use `uuid_generate_v4()` (from uuid-ossp)
- Consistent UUID type across all tables

## Indexes

### Performance Indexes
- Foreign key indexes on all `tenant_id` columns
- Composite indexes for common query patterns
- GIN indexes for array columns (tags, allergens, dependencies)
- Unique indexes for natural keys (slugs, codes, numbers)

### Notable Indexes
- `employee_seniority_current_idx`: Current seniority per employee
- `task_claims_task_id_idx`: Active claims lookup
- `prep_lists_generated_at_idx`: Recent prep lists
- `OutboxEvent_status_createdAt_idx`: Outbox processor queries
- Various tenant-specific composite indexes

## Next Steps
This migration establishes the foundation. Subsequent migrations add:
- Extensions (pgcrypto)
- Reference data seeding (units, waste reasons)
- Feature-specific tables (seniority, labor budgets, etc.)
