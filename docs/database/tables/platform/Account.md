# Account Table

**Schema:** `platform` (platform-level)
**Table:** `Account`
**Primary Key:** `id` (UUID)

## Overview

The `Account` table represents a tenant organization in the Convoy multi-tenant system. This is the central tenant model that is referenced by ALL tenant-scoped tables via the `tenantId` foreign key. Each account corresponds to one catering company or organization using the platform.

**Critical Design Principle:** This table lives in the `platform` schema and does NOT have a `tenantId` column itself, as it IS the tenant definition.

## Columns

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | `UUID` | No | `gen_random_uuid()` | Unique identifier for the account (tenant) |
| `name` | `VARCHAR` | No | - | Display name of the account/organization |
| `slug` | `VARCHAR` | No | - | URL-safe unique identifier for the account (used in subdomains, routing) |
| `defaultTimezone` | `VARCHAR` | No | `"UTC"` | Default timezone for the account (IANA format, e.g., "America/New_York") |
| `weekStart` | `SMALLINT` | No | `1` | Day of week that starts the week (0=Sunday, 1=Monday, etc.) |
| `subscriptionTier` | `VARCHAR` | No | `"trial"` | Subscription tier level (trial, basic, professional, enterprise) |
| `subscriptionStatus` | `VARCHAR` | No | `"active"` | Current subscription status (active, past_due, canceled, etc.) |
| `maxLocations` | `SMALLINT` | No | `1` | Maximum number of locations allowed for this account |
| `maxEmployees` | `SMALLINT` | No | `10` | Maximum number of employees allowed for this account |
| `createdAt` | `TIMESTAMPTZ` | No | `now()` | Timestamp when account was created |
| `updatedAt` | `TIMESTAMPTZ` | No | `now()` | Timestamp when account was last updated |
| `deletedAt` | `TIMESTAMPTZ` | Yes | `NULL` | Soft delete timestamp (NULL = active account) |

## Column Details

### `id`
- **Type:** UUID
- **Description:** Primary key and unique identifier
- **Usage:** Referenced as `tenantId` in all tenant-scoped tables
- **Format:** Standard UUID v4 generated by PostgreSQL

### `name`
- **Type:** VARCHAR
- **Description:** Human-readable organization name
- **Example:** "Ryan's Catering Co.", "Elite Events LLC"
- **Validation:** Required, must be non-empty string

### `slug`
- **Type:** VARCHAR (UNIQUE)
- **Description:** URL-safe identifier used for:
  - Subdomain routing (e.g., `slug.convoy.app`)
  - Organization lookup from auth (Clert orgId → Account.slug)
  - API endpoints and references
- **Validation:** Required, unique across all accounts, URL-safe format
- **Example:** "ryans-catering", "elite-events"

### `defaultTimezone`
- **Type:** VARCHAR
- **Default:** `"UTC"`
- **Description:** Default timezone for the account
- **Format:** IANA timezone database format (e.g., "America/New_York", "Europe/London")
- **Usage:** Scheduling, event timing, reporting timezones

### `weekStart`
- **Type:** SMALLINT
- **Default:** `1` (Monday)
- **Description:** Which day starts the week for scheduling/reporting
- **Values:** 0=Sunday, 1=Monday, 2=Tuesday, ..., 6=Saturday
- **Usage:** Kitchen prep schedules, staff scheduling, weekly reports

### `subscriptionTier`
- **Type:** VARCHAR
- **Default:** `"trial"`
- **Description:** Feature access level for the account
- **Values:**
  - `trial` - Limited access, trial period
  - `basic` - Core features
  - `professional` - Advanced features
  - `enterprise` - Full feature set + custom integrations
- **Usage:** Feature flags, rate limiting, billing calculations

### `subscriptionStatus`
- **Type:** VARCHAR
- **Default:** `"active"`
- **Description:** Current payment/subscription status
- **Values:**
  - `active` - Account in good standing
  - `past_due` - Payment overdue, grace period
  - `canceled` - Subscription canceled, access ending
  - `incomplete` - Initial payment failed
  - `trialing` - In trial period
- **Usage:** Access control, billing logic

### `maxLocations`
- **Type:** SMALLINT
- **Default:** `1`
- **Description:** Maximum number of physical locations allowed
- **Usage:** Location creation validation, tier limits
- **Example:** 1 (basic), 5 (professional), unlimited (enterprise)

### `maxEmployees`
- **Type:** SMALLINT
- **Default:** `10`
- **Description:** Maximum number of employee records allowed
- **Usage:** Employee creation validation, tier limits
- **Example:** 10 (trial), 50 (basic), 200 (professional)

### `createdAt`
- **Type:** TIMESTAMPTZ
- **Default:** `now()`
- **Description:** Account creation timestamp
- **Usage:** Analytics, migration tracking, account age

### `updatedAt`
- **Type:** TIMESTAMPTZ
- **Default:** `now()` (auto-updated)
- **Description:** Last modification timestamp
- **Usage:** Audit trail, change tracking

### `deletedAt`
- **Type:** TIMESTAMPTZ (nullable)
- **Default:** `NULL`
- **Description:** Soft delete timestamp
- **Usage:**
  - `NULL` = Active account
  - Set to timestamp = Account deleted
- **Behavior:** Deleted accounts are excluded from queries with `WHERE deletedAt IS NULL`
- **Cascading:** When an account is soft-deleted, all related tenant data should also be soft-deleted

## Relationships

### One-to-Many Relations (Account → Tenant Tables)

The Account model has relationships to ALL tenant-scoped tables. Every row in tenant tables references exactly one Account via `tenantId`:

**Kitchen Module:**
- `locations` → `Location` (Physical kitchen locations)
- `employees` → `User` (Staff/user accounts)
- `kitchenTasks` → `KitchenTask`
- `prepLists` → `PrepList`
- `prepListItems` → `PrepListItem`
- `prepTasks` → `PrepTask`
- `taskClaims` → `KitchenTaskClaim`
- `taskProgress` → `KitchenTaskProgress`

**Events Module:**
- `events` → `Event`
- `battleBoards` → `BattleBoard`
- `cateringOrders` → `CateringOrder`
- `eventImports` → `EventImport`
- `eventStaffAssignments` → `EventStaffAssignment`
- `eventTimelines` → `EventTimeline`

**CRM Module:**
- `clients` → `Client`
- `clientContacts` → `ClientContact`
- `clientPreferences` → `ClientPreference`
- `leads` → `Lead`
- `interactions` → `ClientInteraction`
- `proposals` → `Proposal`
- `proposalLineItems` → `ProposalLineItem`

**Inventory Module:**
- `inventoryItems` → `InventoryItem`
- `inventoryTransactions` → `InventoryTransaction`
- `inventorySuppliers` → `InventorySupplier`
- `inventoryAlerts` → `InventoryAlert`
- `inventoryStock` → `InventoryStock`
- `inventoryForecasts` → `InventoryForecast`
- `forecastInputs` → `ForecastInput`
- `reorderSuggestions` → `ReorderSuggestion`
- `alertsConfigs` → `AlertsConfig`
- `cycleCountSessions` → `CycleCountSession`
- `cycleCountRecords` → `CycleCountRecord`
- `varianceReports` → `VarianceReport`
- `cycleCountAuditLogs` → `CycleCountAuditLog`
- `purchaseOrders` → `PurchaseOrder`
- `purchaseOrderItems` → `PurchaseOrderItem`
- `shipments` → `Shipment`
- `shipmentItems` → `ShipmentItem`

**Recipe/Menu Module:**
- `recipes` → `Recipe`
- `recipeVersions` → `RecipeVersion`
- `recipeIngredients` → `RecipeIngredient`
- `ingredients` → `Ingredient`
- `prepMethods` → `PrepMethod`
- `containers` → `Container`
- `dishes` → `Dish`
- `menus` → `Menu`
- `menuDishes` → `MenuDish`
- `prepComments` → `PrepComment`

## Key Constraints

### Unique Constraints
- `slug` - Must be unique across all accounts (used for subdomain routing)

### Indexes
- Primary key on `id`
- Unique index on `slug`
- Index on `deletedAt` (for soft delete filtering)

## Tenant Resolution Pattern

### Standard Flow
1. User authenticates via Clerk (auth provider)
2. Clerk returns `orgId` (organization slug)
3. Application resolves `orgId` → `Account.slug` → `Account.id`
4. `Account.id` becomes `tenantId` for all tenant-scoped operations

### Auto-Creation
If an account doesn't exist for a given `orgId`:
```typescript
// From apps/app/app/lib/tenant.ts
let account = await database.account.findFirst({
  where: { slug: orgId, deletedAt: null },
});

if (!account) {
  account = await database.account.create({
    data: {
      name: orgId,
      slug: orgId,
    },
  });
}
```

## Important Notes

1. **Platform Schema:** This table is in the `platform` schema, NOT a tenant schema
2. **No Tenant ID:** Does not have `tenantId` column - it IS the tenant
3. **Soft Deletes:** Uses `deletedAt` for soft deletes - never hard delete accounts
4. **Slug Uniqueness:** Critical for multi-tenancy - must be globally unique
5. **Tier Limits:** `maxLocations` and `maxEmployees` should be enforced at application level
6. **Timezone Awareness:** All account-level operations should respect `defaultTimezone`
7. **Week Configuration:** `weekStart` affects scheduling UI and weekly reporting

## Verification Status

**Frontmatter:**
```yaml
first_documented: "2026-01-30"
last_updated: "2026-01-30"
last_verified_by: "spec-executor (T013)"
verification_status: "documented_from_schema"
```

**Notes:**
- Documented from `packages/database/prisma/schema.prisma` (lines 12-72)
- Relationships verified against all tenant-scoped models
- No existing documentation to compare against (new documentation)
- Should be verified against actual database schema in production
