# sent_emails

> **First documented**: 2025-01-30
> **Last updated**: 2025-01-30
> **Last verified by**: spec-executor
> **Verification status**: ⚠️ Needs verification

---

## Overview

The `sent_emails` table tracks all emails sent through the Resend integration for observability, debugging, and deliverability monitoring.

**Business Context**: Email tracking for transactional emails (password resets, notifications, contract sends, proposal deliveries) sent via Resend.

**Key Use Cases**:
- Track email delivery for debugging failed sends
- Monitor email deliverability across all tenants
- Provide audit trail for compliance (e.g., contract delivery confirmations)
- Detect abuse patterns (spamming, rate limit violations)
- Analyze email volume per tenant for billing/limits

**Lifecycle**: Email sent → Tracked in table → Retained for 1 year → Purged

## Schema Reference

```sql
-- PostgreSQL schema reference
CREATE TABLE platform.sent_emails (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  recipient_email VARCHAR NOT NULL,
  subject VARCHAR NOT NULL,
  correlation_id VARCHAR,
  sent_at TIMESTAMPTZ NOT NULL DEFAULT now()

  -- Indexes
  INDEX sent_emails_tenant_idx (tenant_id)
);

-- Prisma model reference
// File: packages/database/prisma/schema.prisma
// Model: sent_emails (line ~1932)
```

**Click-to-navigate**: Ctrl+click (Cmd+click on Mac) the Prisma schema path above to jump to the model definition.

## Columns

| Column | Type | Nullable | Default | Purpose | Notes |
|--------|------|----------|---------|---------|-------|
| `id` | UUID | No | gen_random_uuid() | Primary key | Auto-generated |
| `tenant_id` | UUID | No | - | Tenant FK | Links to platform.accounts, indexed |
| `recipient_email` | VARCHAR | No | - | Recipient address | Email address that received the message |
| `subject` | VARCHAR | No | - | Email subject line | For identification/searching |
| `correlation_id` | VARCHAR | Yes | NULL | Tracking identifier | Optional ID for linking to business entity (e.g., contract_id, proposal_id) |
| `sent_at` | TIMESTAMPTZ | No | now() | Send timestamp | Auto-generated, indexed for time queries |

### Column Details

#### tenant_id

- **Type**: UUID
- **Nullable**: No
- **Default**: None (required)
- **Purpose**: Links email to specific tenant for multi-tenancy
- **Validation**: Foreign key to `platform.accounts(id)`
- **Business rules**: Required for all emails (even system-level emails use a system tenant)
- **Gotchas**: Unlike most platform tables, sent_emails has tenant_id for filtering/analytics

#### recipient_email

- **Type**: VARCHAR
- **Nullable**: No
- **Default**: None
- **Purpose**: Email address that received the message
- **Validation**: Should be valid email format (application-level)
- **Business rules**: Can be external (outside tenant) or internal (tenant user)
- **Gotchas**: Not a FK - can be any email address (customers, vendors, etc.)

#### subject

- **Type**: VARCHAR
- **Nullable**: No
- **Default**: None
- **Purpose**: Email subject line for human identification
- **Validation**: Application-level (Resend validates subject exists)
- **Business rules**: Should include context (e.g., "Contract: ABC-123 - Signature Request")
- **Gotchas**: May contain PII (customer names, event details)

#### correlation_id

- **Type**: VARCHAR
- **Nullable**: Yes
- **Default**: NULL
- **Purpose**: Optional business entity identifier for linking
- **Validation**: Application-level (format varies by use case)
- **Business rules**: Set when email relates to specific record (contract_id, proposal_id, etc.)
- **Gotchas**: Not a FK - free-form string for flexibility
- **Examples**: "contract_abc123", "proposal_def456", "event_789"

#### sent_at

- **Type**: TIMESTAMPTZ
- **Nullable**: No
- **Default**: now()
- **Purpose**: Timestamp when email was sent
- **Validation**: Auto-generated by database
- **Business rules**: Immutable (never updated after insert)
- **Gotchas**: Use for time-based queries (email volume, delivery trends)

## Relations

### Belongs To

- **Belongs to** [`platform.accounts`](../schemas/00-platform.md#account) via `tenant_id`
  - **Required**: Yes
  - **Validation**: Foreign key constraint
  - **On Delete**: No cascade (emails retained for audit trail)

### Cross-Schema

**No direct relations to tenant schema tables** - correlation_id provides optional loose coupling to business entities.

### Click-to-Navigate

All table references above are clickable links. Ctrl+click (Cmd+click on Mac) to jump to related table documentation.

## Business Rules

### Email Tracking Requirements

- **Rule**: Every email sent via Resend MUST be recorded in sent_emails
- **Enforcement**: Application layer (email service wrapper)
- **Violation**: Breaks audit trail, compliance violations (contract delivery proof)

### Tenant Isolation

- **Rule**: Queries must filter by tenant_id (except platform admins)
- **Enforcement**: Application layer + RLS policy (TODO: not yet implemented)
- **Violation**: Cross-tenant email data leakage

### Data Retention

- **Rule**: Retain emails for 1 year, then purge
- **Enforcement**: Cron job or scheduled task
- **Violation**: Storage costs grow indefinitely

### Correlation ID Format

- **Rule**: correlation_id format: `{entity_type}_{entity_id}`
- **Enforcement**: Application layer (email service wrapper)
- **Violation**: Hard to link emails to business entities
- **Examples**:
  - `contract_abc123-def456-...` (Contract delivery)
  - `proposal_def456-ghi789-...` (Proposal delivery)
  - `password_reset_user123` (Auth email)

## Type Fixing

### Type Consistency Check

```markdown
- [x] Verified: `tenant_id` type consistency
  - **Prisma**: String @db.Uuid
  - **PostgreSQL**: UUID
  - **Status**: ✅ Consistent

- [x] Verified: `id` type consistency
  - **Prisma**: String @db.Uuid
  - **PostgreSQL**: UUID DEFAULT gen_random_uuid()
  - **Status**: ✅ Consistent

- [x] Verified: `sent_at` type consistency
  - **Prisma**: DateTime @db.Timestamptz(6)
  - **PostgreSQL**: TIMESTAMPTZ(6) DEFAULT now()
  - **Status**: ✅ Consistent
```

### Nullability Issues Found

```markdown
- [x] Verified: `correlation_id` nullability
  - **Prisma**: String? (optional)
  - **PostgreSQL**: VARCHAR (no NOT NULL constraint)
  - **Status**: ✅ Consistent (correctly optional)

- [x] Verified: All other columns non-nullable
  - **tenant_id**: Required ✅
  - **recipient_email`: Required ✅
  - `subject`: Required ✅
  - `sent_at`: Required ✅
```

### TODOs: Type Issues

```markdown
- [ ] [P1] Add RLS policy for tenant isolation - current: anyone can query all emails - migration: 20250201_add_sent_emails_rls
```

## Queries

### Fetch Recent Emails for Tenant

```sql
-- Prisma
await prisma.sentEmails.findMany({
  where: {
    tenant_id: tenantId
  },
  orderBy: { sent_at: 'desc' },
  take: 50
});

-- SQL
SELECT *
FROM platform.sent_emails
WHERE tenant_id = $1
ORDER BY sent_at DESC
LIMIT 50;
```

**Index used**: `sent_emails_tenant_idx`

### Fetch Emails by Correlation ID

```sql
-- Prisma
await prisma.sentEmails.findMany({
  where: {
    correlation_id: `contract_${contractId}`
  },
  orderBy: { sent_at: 'desc' }
});

-- SQL
SELECT *
FROM platform.sent_emails
WHERE correlation_id = $1
ORDER BY sent_at DESC;
```

**Performance**: No index on correlation_id (low cardinality, infrequent queries)

### Fetch Email Volume by Date Range

```sql
-- Prisma
await prisma.sentEmails.groupBy({
  by: ['sent_at'],
  where: {
    tenant_id: tenantId,
    sent_at: {
      gte: startDate,
      lte: endDate
    }
  },
  _count: true
});

-- SQL
SELECT DATE(sent_at) as date, COUNT(*) as count
FROM platform.sent_emails
WHERE tenant_id = $1
  AND sent_at >= $2
  AND sent_at <= $3
GROUP BY DATE(sent_at)
ORDER BY date;
```

**Performance**: Consider adding index on `(tenant_id, sent_at)` if analytics feature added

### Gotchas

- **Missing RLS policy**: Currently anyone can query all tenant emails (security issue)
- **No status tracking**: Table doesn't track delivery status (bounced, delivered, opened) - would require webhook integration
- **No email content**: Only subject stored (body not retained for PII/storage reasons)
- **Correlation ID not validated**: Free-form string, format not enforced (application convention only)

## TODOs

### High Priority

```markdown
- [ ] [P0] Implement email tracking wrapper - current: emails not logged to table - due: 2025-02-15
  - Create email service that wraps Resend client
  - Auto-insert sent_emails record on every send
  - Handle failures gracefully (log even if send fails)

- [ ] [P0] Add RLS policy for tenant isolation - current: no RLS - due: 2025-02-01
  - Policy: tenants can only query their own sent_emails.tenant_id
  - Migration: 20250201_add_sent_emails_rls
```

### Medium Priority

```markdown
- [ ] [P2] Add composite index on (tenant_id, sent_at) - query: email analytics - planned: 2025-03-01
- [ ] [P2] Implement email archival job - retention: 1 year - planned: 2025-03-15
- [ ] [P2] Add correlation_id index - query: contract/proposal email lookup - planned: 2025-03-01
```

### Low Priority

```markdown
- [ ] [P3] Add delivery status tracking - requires: Resend webhooks - low priority
- [ ] [P3] Add email category/type column - values: transactional, marketing, system - nice to have
- [ ] [P3] Consider partitioning by sent_at - expected volume: 100/day/tenant - optional
```

### Migration Required

```markdown
- [ ] **MIGRATION REQUIRED**: Add RLS policy to sent_emails
  - **Current**: No RLS policies (anyone can query all emails)
  - **Should be**: RLS policy ensures tenants only see their own sent_emails.tenant_id
  - **Impact**: Security vulnerability - email data leakage
  - **Migration**: `20250201_add_sent_emails_rls`
  - **Assigned**: spec-executor
  - **Due**: 2025-02-01
```

## Related Tables

- [`platform.accounts`](../schemas/00-platform.md#account) - Tenant that sent the email (via tenant_id)
- [`tenant_events.Contract`](../tables/tenant_events/Contract.md) - Contract emails use correlation_id
- [`tenant_crm.Proposal`](../tables/tenant_crm/Proposal.md) - Proposal emails use correlation_id

## Related Code

- **Prisma Model**: [`packages/database/prisma/schema.prisma`](../../../../packages/database/prisma/schema.prisma#L1932)
- **Email Package**: [`packages/email/index.ts`](../../../../packages/email/index.ts) - Resend client wrapper
- **Contract Send Route**: `apps/api/app/api/events/contracts/[id]/send/route.ts` - Example email send
- **Proposal Send Route**: `apps/api/app/api/crm/proposals/[id]/send/route.ts` - Example email send

## See Also

- **Schema Documentation**: [`../schemas/00-platform.md`](../schemas/00-platform.md)
- **Schema Overview**: [`../SCHEMAS.md`](../SCHEMAS.md)
- **Known Issues**: [`../KNOWN_ISSUES.md`](../KNOWN_ISSUES.md)
- **Migration History**: [`../migrations/README.md`](../migrations/README.md)
