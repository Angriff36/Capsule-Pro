# Task Plan: Events Module (Convoy)

## Goal
Deliver an initial Events module in `apps/app` with a clear data model contract, API shape, and a working UI scaffold (list + detail), aligned to Convoy's multi-tenant direction.

## Current Phase
Phase 4

## Phases

### Phase 1: Requirements & Discovery
- [x] Confirm scope for Events MVP (fields, flows, UI screens)
- [x] Review existing Convoy structure + relevant specs
- [x] Document findings in findings.md
- **Status:** complete

### Phase 2: Data Model & API Shape
- [x] Define Events domain model (fields, status, relations) from Capsule migrations
- [x] Choose storage approach for MVP (Prisma in this worktree)
- [x] Import Capsule Supabase migrations + schema contract
- [x] Outline API routes and payloads (server actions for CRUD)
- **Status:** complete

### Phase 3: UI Implementation
- [x] Add Events routes in `apps/app` (list + detail)
- [x] Wire UI to API/data layer
- [x] Add empty states and loading states
- **Status:** complete

### Phase 4: Testing & Verification
- [ ] Verify flows manually (list, create, edit, delete)
- [x] Regenerate Prisma client after schema updates
- [ ] Add tests if repo patterns exist
- [x] Document test results in progress.md
- **Status:** in_progress

### Phase 6: Import & Seed
- [x] Add CSV/PDF import flow for events
- [x] Seed events + dishes + prep tasks from CSVs
- [ ] Verify import results in UI
- **Status:** in_progress

### Phase 5: Delivery
- [ ] Review changes and update docs if needed
- [ ] Summarize work + next steps
- **Status:** pending

## Key Questions
1. What is the minimal Events flow for MVP (list+detail+create+edit+delete confirmed)?
2. What shared fields are required for cross-module sync beyond event_number + updated_at?

## Decisions Made
| Decision | Rationale |
|----------|-----------|
| Use Prisma models in this worktree for Events | Matches current repo setup and user direction |
| Events MVP includes list, create, edit, detail, and delete views | Required baseline functionality for module |
| Capsule Supabase migrations remain source of truth | Preserves RLS/policies/triggers and contract registry |

## Errors Encountered
| Error | Attempt | Resolution |
|-------|---------|------------|
| Prisma schema validation error (optional list for tags) | 1 | Made tags a non-optional list with default [] |
| Supabase migrations failed on Neon (missing roles/postgres, fn_audit_trigger) | 1 | Create required roles and re-run migrations with Neon-compatible approach |
| Supabase migrations failed on Neon (SET ROLE postgres + existing schema conflicts) | 2 | Skip `20251222000100_*` dump file and re-run remaining migrations |
| Prisma generate failed with missing @@schema on public models/enums + missing tenant relations | 1 | Added @@schema("public") to enums/models and tenant relations for claims/progress |
| App typecheck failed on database.page references + budget typing | 1 | Swap dashboard/search to events + allow undefined in budget formatter |
| Runtime DriverAdapterError invalid uuid for tenant_id (Clerk orgId) | 1 | Add tenant lookup/upsert using orgId slug before querying events |
| Prisma db push failed due to platform schema missing in datasource.schemas | 1 | Add "platform" to Prisma datasource schemas and retry db push |
| Prisma db push failed due to tenant_kitchen schema missing in datasource.schemas | 1 | Add "tenant_kitchen" to Prisma datasource schemas and retry db push |
| Prisma db push failed due to tenant_crm schema missing in datasource.schemas | 1 | Add "tenant_crm" to Prisma datasource schemas and retry db push |
| Prisma schema validation failed due to multiline schemas array | 1 | Use single-line schemas array in Prisma datasource |
| Prisma db push failed due to tenant_staff schema missing in datasource.schemas | 1 | Add tenant_staff (and other tenant schemas) to Prisma datasource schemas |
| Prisma db push failed due to core schema missing in datasource.schemas | 1 | Add core to Prisma datasource schemas |
| Prisma db push failed due to missing FK constraint in drifted DB | 1 | Create `public."Tenant"` via direct SQL instead of db push |
| Seed SQL failed due to auth.users schema mismatch in Neon | 1 | Generate no-auth seed file and load it |
| CSV seed script failed due to empty UUIDs from here-string generation | 1 | Generate UUIDs outside here-strings and trim IDs |
| CSV seed script failed due to duplicate event_dishes | 1 | Use ON CONFLICT with partial index predicate |
| Event import attachment storage needed | 1 | Add event_imports table + store file bytes in DB |

## Notes
- Update phase status as you progress: pending -> in_progress -> complete
- Re-read this plan before major decisions
- Log ALL errors to avoid repeats
