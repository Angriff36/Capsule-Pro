# Manifest Integration - IMPLEMENTATION PLAN

**Date**: 2026-02-23
**Status**: RESOLVED - DOCUMENTATION UPDATED
**Agent**: Senior Engineer (Documentation Update)

---

## RESOLUTION SUMMARY

The planned migration to `packages/manifest-sources/kitchen/` was **never implemented**. The current structure works correctly and documentation has been updated to match reality.

### Key Facts

| Item | Reality |
|------|---------|
| **Canonical manifest location** | `packages/manifest-adapters/manifests/*.manifest` |
| **Number of manifest files** | 40 files |
| **manifest.config.yaml path** | `packages/manifest-adapters/manifests/*.manifest` |
| **Tests** | All passing |
| **Migration needed** | None - current structure is canonical |

### What Changed From Original Plan

The original implementation plan documented a planned migration from `packages/manifest-adapters/manifests/` to `packages/manifest-sources/kitchen/`. This migration was:
- Planned but never executed
- The `packages/manifest-sources/` directory was never created
- The `manifest.config.yaml` was updated to point to the existing `manifest-adapters/manifests` location
- All 40 manifests remain in their original location and work correctly

### Resolution Actions Taken

1. Documentation updated to reflect actual canonical path
2. No code changes required - system works as-is
3. Original analysis archived below for historical reference

---

## CURRENT CANONICAL STRUCTURE

### Artifact Type Locations (Actual Implementation)

| Artifact Type | Source of Truth | Generated Output Location | Consumer Import Path |
|--------------|----------------|--------------------------|---------------------|
| **Manifest Sources** | `packages/manifest-adapters/manifests/*.manifest` | N/A (human-authored) | N/A |
| **Compiled IR** | Generated by `pnpm manifest:compile` | `packages/manifest-ir/ir/kitchen/*.json` | `@repo/manifest-ir` |
| **IR Access Helpers** | Handwritten | N/A | `@repo/manifest-ir` |
| **Runtime Adapters** | Handwritten | N/A | `@repo/manifest-adapters/*` |
| **App Runtime Wrapper** | Handwritten | N/A | `@/lib/manifest-runtime` |
| **Command API Routes** | Generated by `pnpm manifest:generate` | `apps/api/app/api/kitchen/**/commands/*/route.ts` | N/A (HTTP endpoints) |

### Developer Workflow (Current)

```bash
# 1. Edit manifest source
vim packages/manifest-adapters/manifests/prep-task-rules.manifest

# 2. Compile to IR
pnpm manifest:compile

# 3. Generate routes
pnpm manifest:generate

# 4. Build and test
pnpm build && pnpm test
```

---

## MANIFEST FILES INVENTORY (40 files)

Location: `packages/manifest-adapters/manifests/`

| File | Purpose |
|------|---------|
| alerts-config-rules.manifest | Alert configuration rules |
| allergen-warning-rules.manifest | Allergen warning rules |
| battle-board-rules.manifest | Battle board domain rules |
| catering-order-rules.manifest | Catering order rules |
| client-interaction-rules.manifest | Client interaction rules |
| client-rules.manifest | Client domain rules |
| command-board-rules.manifest | Command board domain rules |
| container-rules.manifest | Container domain rules |
| cycle-count-rules.manifest | Cycle count rules |
| dish-rules.manifest | Dish domain rules |
| event-budget-rules.manifest | Event budget rules |
| event-contract-rules.manifest | Event contract rules |
| event-dish-rules.manifest | Event dish rules |
| event-guest-rules.manifest | Event guest rules |
| event-report-rules.manifest | Event report rules |
| event-rules.manifest | Event domain rules |
| event-staff-rules.manifest | Event staff rules |
| ingredient-rules.manifest | Ingredient domain rules |
| inventory-rules.manifest | Inventory domain rules |
| inventory-supplier-rules.manifest | Inventory supplier rules |
| inventory-transaction-rules.manifest | Inventory transaction rules |
| kitchen-task-rules.manifest | Kitchen task rules |
| lead-rules.manifest | Lead domain rules |
| menu-rules.manifest | Menu domain rules |
| notification-rules.manifest | Notification rules |
| override-audit-rules.manifest | Override audit rules |
| prep-comment-rules.manifest | Prep comment rules |
| prep-list-rules.manifest | Prep list domain rules |
| prep-method-rules.manifest | Prep method rules |
| prep-task-rules.manifest | Prep task domain rules |
| proposal-rules.manifest | Proposal domain rules |
| purchase-order-rules.manifest | Purchase order rules |
| recipe-rules.manifest | Recipe domain rules |
| role-policy-rules.manifest | Role policy rules |
| schedule-rules.manifest | Schedule domain rules |
| shipment-rules.manifest | Shipment domain rules |
| station-rules.manifest | Station domain rules |
| time-entry-rules.manifest | Time entry rules |
| user-rules.manifest | User domain rules |
| waste-entry-rules.manifest | Waste entry rules |
| workflow-rules.manifest | Workflow domain rules |

---

## DEFINITION OF DONE

### Integration Complete (Verified 2026-02-23)

1. [x] All manifest files in canonical location (`packages/manifest-adapters/manifests/`)
2. [x] `manifest.config.yaml` correctly references canonical path
3. [x] `pnpm manifest:compile` produces correct IR
4. [x] `pnpm manifest:generate` produces routes
5. [x] All tests passing
6. [x] `pnpm build` succeeds
7. [x] Documentation matches reality

---

## ARCHIVED HISTORICAL ANALYSIS

> **NOTE**: The following sections contain the original analysis from 2026-02-10 that was based on a planned migration that was never executed. This content is preserved for historical reference only. The planned `packages/manifest-sources/` directory was never created.

---

# ARCHIVED: Original Analysis (2026-02-10)

**Original Status**: ANALYSIS COMPLETE - CONFLICTS IDENTIFIED
**Original Agent**: Senior Engineer (Synthesis)

---

## ARCHIVED: EXECUTIVE SUMMARY

The Manifest integration in Capsule-Pro was **PRODUCTION READY** with 42 command API routes generated and working. The original analysis identified conflicts that were based on a planned migration that was never executed.

### Original Analysis State (Working)
- 42 command API routes generated at `apps/api/app/api/kitchen/**/commands/*/route.ts`
- All tests passing (180 runtime tests, snapshot tests, conformance tests)
- TypeScript compilation successful across codebase
- Runtime execution working with PrismaStore integration

### Original "Critical Issues" Identified (Now Resolved by Accepting Current Structure)
- DUPLICATE manifest sources - **RESOLVED**: The planned `manifest-sources` directory was never created; `manifest-adapters/manifests` is the only location
- Documentation conflicts - **RESOLVED**: Documentation updated to match reality
- Runtime factory references - **RESOLVED**: Current references are correct

---

## ARCHIVED: PART 1 - DIRECTORY MAP (Planned vs Actual)

The original plan documented these directories:

| Directory | Planned Purpose | Actual Status |
|-----------|----------------|---------------|
| `packages/manifest-sources/` | **CANONICAL** per original plan | **NEVER CREATED** |
| `packages/manifest-sources/kitchen/` | Human-authored domain rules | **NEVER CREATED** |
| `packages/manifest-ir/` | Compiled IR artifacts | Works correctly |
| `packages/manifest-ir/ir/kitchen/` | Compiled IR from sources | Works correctly |
| `packages/manifest-adapters/` | Runtime adapter code | Works correctly |
| `packages/manifest-adapters/manifests/` | Legacy location (planned removal) | **IS CANONICAL LOCATION** |

---

## ARCHIVED: PART 2 - CONFLICT LIST

The original analysis identified these conflicts based on the planned migration:

| # | Original Conflict | Resolution |
|---|-------------------|------------|
| 1 | Duplicate manifest sources | No duplicates - `manifest-sources` never created |
| 2 | Documentation contradiction | Documentation updated to match reality |
| 3 | Runtime factory path | Current path is correct |
| 4 | Manifest config path | Config updated to use `manifest-adapters/manifests` |
| 5 | Missing lib directory | Not required for current implementation |

---

## ARCHIVED: PART 3 - CANONICAL LOCATION TABLE (Planned)

The original plan defined this structure:

| Artifact Type | Planned Location | Actual Location |
|--------------|------------------|-----------------|
| **Manifest Sources** | `packages/manifest-sources/kitchen/*.manifest` | `packages/manifest-adapters/manifests/*.manifest` |
| **Compiled IR** | `packages/manifest-ir/ir/kitchen/*.json` | Same (unchanged) |
| **Legacy Manifests** | DELETE | **This IS the canonical location** |

---

## ARCHIVED: PART 4 - REPO CONVENTIONS (Original)

### Original File Placement Rules

```
PLANNED:
  DO: Place .manifest files in packages/manifest-sources/kitchen/
  DON'T: Place .manifest files in packages/manifest-adapters/manifests/

ACTUAL:
  DO: Place .manifest files in packages/manifest-adapters/manifests/
  This is the canonical location
```

---

## ARCHIVED: PART 5 - IMPLEMENTATION PLAN (Original)

The original plan included these tasks that were never executed:

### PHASE 1: RESOLVE CRITICAL CONFLICTS (Never Executed)

| # | Task | Status |
|---|------|--------|
| 1.1 | Migrate missing manifests to `packages/manifest-sources/kitchen/` | NEVER DONE |
| 1.2 | Fix runtime factory to reference correct manifest location | NOT NEEDED |
| 1.3 | Update all documentation to reflect canonical structure | DONE (updated to match reality) |
| 1.4 | Remove duplicate manifests from `packages/manifest-adapters/manifests/` | NOT DONE (this is canonical) |
| 1.5 | Recompile IR from canonical sources | NOT NEEDED |
| 1.6 | Regenerate routes from canonical IR | NOT NEEDED |
| 1.7 | Verify tests pass after restructure | Tests pass with current structure |

### PHASE 2-4: CLEANUP AND ENHANCEMENTS

The remaining phases (projection output cleanup, missing directory structure, optional enhancements) were also not executed as the current structure works correctly.

---

## APPENDICES (Still Valid)

### Appendix A: Generated Routes Inventory

Command routes at `apps/api/app/api/kitchen/`:

**PrepTask (7 routes):**
- `/prep-tasks/commands/claim`
- `/prep-tasks/commands/start`
- `/prep-tasks/commands/complete`
- `/prep-tasks/commands/release`
- `/prep-tasks/commands/reassign`
- `/prep-tasks/commands/update-quantity`
- `/prep-tasks/commands/cancel`

**PrepList (7 routes):**
- `/prep-lists/commands/finalize`
- `/prep-lists/commands/mark-completed`
- `/prep-lists/commands/update`
- `/prep-lists/commands/update-batch-multiplier`
- `/prep-lists/commands/activate`
- `/prep-lists/commands/deactivate`
- `/prep-lists/commands/cancel`

**PrepListItem (5 routes):**
- `/prep-lists/items/commands/update-quantity`
- `/prep-lists/items/commands/update-station`
- `/prep-lists/items/commands/update-prep-notes`
- `/prep-lists/items/commands/mark-completed`
- `/prep-lists/items/commands/mark-uncompleted`

**Menu (3 routes):**
- `/menus/commands/update`
- `/menus/commands/activate`
- `/menus/commands/deactivate`

**Station (6 routes):**
- `/stations/commands/assignTask`
- `/stations/commands/removeTask`
- `/stations/commands/updateCapacity`
- `/stations/commands/activate`
- `/stations/commands/deactivate`
- `/stations/commands/updateEquipment`

**Inventory (6 routes):**
- `/inventory/commands/reserve`
- `/inventory/commands/consume`
- `/inventory/commands/waste`
- `/inventory/commands/adjust`
- `/inventory/commands/restock`
- `/inventory/commands/release-reservation`

**Recipe (3 routes):**
- `/recipes/commands/update`
- `/recipes/commands/activate`
- `/recipes/commands/deactivate`

**Dish (2 routes):**
- `/dishes/commands/update-pricing`
- `/dishes/commands/update-lead-time`

**Ingredient (1 route):**
- `/ingredients/commands/update-allergens`

**RecipeIngredient (1 route):**
- `/recipe-ingredients/commands/update-quantity`

**RecipeVersion (1 route):**
- `/recipes/versions/commands/create`

### Appendix B: Import Path Reference

| What You Need | Import From | Example |
|---------------|-------------|---------|
| Read IR | `@repo/manifest-ir` | `import { readKitchenIr } from "@repo/manifest-ir"` |
| Runtime Engine | `@repo/manifest-adapters/runtime-engine` | `import { ManifestRuntimeEngine } from "@repo/manifest-adapters/runtime-engine"` |
| Prisma Store | `@repo/manifest-adapters/prisma-store` | `import { PrismaStore } from "@repo/manifest-adapters/prisma-store"` |
| API Response Helpers | `@repo/manifest-adapters/route-helpers` | `import { manifestSuccessResponse } from "@repo/manifest-adapters/route-helpers"` |
| App Runtime Factory | `@/lib/manifest-runtime` | `import { createManifestRuntime } from "@/lib/manifest-runtime"` |
| Manifest Types | `@manifest/runtime` | `import type { RuntimeEngine, IR } from "@manifest/runtime"` |

### Appendix C: Troubleshooting

**Problem**: "Cannot find manifest file"
**Solution**: Check `manifest.config.yaml` `src` path matches actual file location

**Problem**: "IR compilation fails"
**Solution**: Ensure `@manifest/runtime` is built: `cd node_modules/@manifest/runtime && pnpm build`

**Problem**: "Routes not generating"
**Solution**: Check projection output directory in `manifest.config.yaml`

**Problem**: "Tests fail after restructure"
**Solution**: Ensure IR was recompiled after moving manifest files
