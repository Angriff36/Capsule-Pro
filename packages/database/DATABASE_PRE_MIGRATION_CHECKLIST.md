<!--
  This checklist is required before creating or modifying any `.sql` migration file.

  AI agents and humans alike must:
    1. Review `packages/database/schema-registry-v2.txt` (tenant rules, RLS expectations, audit/index requirements).
    2. Cross-check the canonical `packages/database/schema-registry-v2.txt` entry for the table(s) you're touching.
    2. Verify Prisma (`packages/database/prisma/schema.prisma`) will remain in sync.
    3. Confirm you understand RLS policies, indices, and soft-delete expectations for the schema in question.
    4. Add a checked checklist entry (see format) that documents these steps before committing.

  Entries go at the bottom of this file as soon as the migration is ready to land.
-->

# Database Pre-Migration Checklist Log

Each SQL file that touches the schema must have a corresponding checked entry below. Include the relative path, a short confirmation of what you reviewed, and any relevant links (contract page, registry sections, Prisma updates, etc.).

Example entry:

```
- [x] supabase/migrations/20260130000000_create_timeline_tasks.sql — Reviewed Schema Contract sections B/D/L, added `timeline_tasks` to Registry, confirmed Prisma model.
```

If an entry is missing for a staged `.sql` file, the pre-commit hook will fail and remind you to update this checklist.

---
- [x] create_timeline_tasks_table.sql — Reviewed Schema Contract sections B/D/G/L; added TIMESTAMPTZ, integrity checks, tenant-aware partial indexes, RLS policies, and standard triggers (update timestamp, prevent tenant mutation, audit). Registry alignment confirmed for tenant_events; Prisma sync planned in packages/database.
- [x] 20260121000000_battle_board_timeline_tasks.sql — Reviewed Schema Contract sections B/D/G/K/L; added composite PK (tenant_id, id), RLS policies (5), all required indexes (tenant, active, event, assignee, status, priority, start_time, critical_path, dependencies GIN), standard triggers (update timestamp, prevent tenant mutation, audit), REPLICA IDENTITY for real-time, and FK constraints to events and employees tables. Added timeline_tasks entry to Schema Registry v2.txt. Prisma model TimelineTask already exists and is in sync.
- [x] 20260122000000_event_profitability.sql — Reviewed Schema Contract sections B/D/L; added composite PK (tenant_id, id), RLS policies (5), indexes (event_id, tenant_id+event_id, calculated_at), standard triggers (update timestamp, prevent tenant mutation), REPLICA IDENTITY for real-time, and FK to events table with CASCADE delete. Added EventProfitability model to Prisma schema. Tracks profitability metrics including budgeted vs actual revenue, food/labor/overhead costs, gross margins, and variance analysis.
- [x] 20260123000000_inventory_forecasting.sql — Reviewed Schema Contract sections B/D/L; added inventory_forecasts, forecast_inputs, reorder_suggestions, alerts_config to tenant_inventory schema in Registry; confirmed Prisma models with tenant_id, composite PKs, RLS policies, standard triggers, indexes, and audit patterns.
- [x] 20260122000001_purchase_orders_receiving.sql — Reviewed Schema Contract sections B/D/G/K/L; added purchase_orders and purchase_order_items tables to tenant_inventory schema with composite PKs (tenant_id, id), RLS policies (5 each), all required indexes (tenant, active, vendor, status, date, po_number for orders; tenant, active, po, item, quality for items), standard triggers (update timestamp, prevent tenant mutation, audit), REPLICA IDENTITY for real-time, FK constraints to inventory_suppliers, locations, and inventory_items. Added receiving workflow fields: quality_status (pending/approved/rejected/needs_inspection), discrepancy_type (shortage/overage/damaged/wrong_item/none), discrepancy_amount. Prisma models PurchaseOrder and PurchaseOrderItem added and synced.
- [x] 20260122000002_waste_tracking.sql — Reviewed Schema Contract sections B/D/E/G/K/L; added core.waste_reasons lookup table with standard waste reasons (spoilage, overproduction, prep_error, burnt, expired, quality, dropped, leftovers, customer_return, other) and tenant_kitchen.waste_entries table with composite PK (tenant_id, id), RLS policies (5), all required indexes (tenant, active, item, reason, location, event, logged_by, logged_at DESC), standard triggers (update timestamp, prevent tenant mutation, audit), REPLICA IDENTITY for real-time, and FK constraints to core.waste_reasons, tenant_inventory.inventory_items, tenant.locations, tenant_events.events, tenant_staff.employees, and core.units. Added waste tracking spec compliance: quantity > 0, costs >= 0, CHECK constraint for valid reason_id. Added entries to Schema Registry v2.txt for core.waste_reasons and tenant_kitchen.waste_entries. Prisma models WasteReason and WasteEntry added to schema.prisma.
- [x] 20260122000003_prep_lists.sql — Reviewed Schema Contract sections B/D/E/G/K/L; added tenant_kitchen.prep_lists and tenant_kitchen.prep_list_items tables with composite PKs (tenant_id, id), RLS policies (5 each), all required indexes (tenant, active, event, status, generated_at for lists; tenant, active, prep_list, station, ingredient, completed, station+completed for items), standard triggers (update timestamp, prevent tenant mutation, audit), REPLICA IDENTITY for real-time, and FK constraints to tenant_events.events, tenant_kitchen.ingredients, and tenant_staff.employees. Supports prep list persistence, manual quantity editing, completion tracking, and station-based organization. Prisma models PrepList and PrepListItem added to schema.prisma.
- [x] 20260122000004_allergen_tracking.sql — Reviewed Schema Contract sections B/D/E/G/K/L; added tenant_events.event_guests and tenant_kitchen.allergen_warnings tables with composite PKs (tenant_id, id), RLS policies (5 each), all required indexes (tenant, active, event, dietary_restrictions GIN, allergen_restrictions GIN for guests; tenant, active, event, dish, warning_type, is_acknowledged, allergens GIN for warnings), standard triggers (update timestamp, prevent tenant mutation, audit), REPLICA IDENTITY for real-time, and FK constraints to tenant_events.events, tenant_kitchen.dishes, and tenant_staff.employees. Supports guest dietary restriction tracking, allergen conflict detection, warning acknowledgment workflow with override reasons, and resolution tracking. Prisma models EventGuest and AllergenWarning added to schema.prisma. Added entries to Schema Registry v2.txt for tenant_events.event_guests and tenant_kitchen.allergen_warnings.
- [x] 20260122000006_time_off_requests.sql — Reviewed Schema Contract sections B/D/E/G/K/L; added tenant_staff.employee_time_off_requests table with composite PK (tenant_id, id), RLS policies (5), all required indexes (tenant+status, employee, date range, tenant+date, processed_by), standard triggers (update timestamp, prevent tenant mutation, audit), and FK to tenant_staff.employees. Added time_off_status and time_off_type enums to tenant_staff schema. Supports time-off request workflow with PENDING/APPROVED/REJECTED/CANCELLED status, multiple request types (vacation, sick leave, personal day, bereavement, maternity/paternity leave, other), overlap prevention via fn_check_time_off_overlap function, and audit trail with processed_by and rejection_reason. Added employee_time_off_requests model to Prisma schema.prisma with TenantStaffTimeOffStatus and TenantStaffTimeOffType enums. Added entry to Schema Registry v2.txt for tenant_staff.employee_time_off_requests and enum types.
- [x] 20260122000007_venues.sql — Reviewed Schema Contract sections B/D/E/G/K/L; added tenant_crm.venues table with composite PK (tenant_id, id), RLS policies (5), all required indexes (tenant, active, type, city, capacity, name GIN, tags GIN), standard triggers (update timestamp, prevent tenant mutation, audit), CHECK constraints (capacity positive, email format), and helper functions (fn_can_delete_venue, fn_venue_event_history). Added Venue model to Prisma schema.prisma. Added venue_id column to tenant_events.events for optional venue linking. Supports venue management with equipment list, preferred vendors, access/catering notes, layout images, tags, and event history tracking. Added tenant_crm.venues entry to Schema Registry v2.txt.
- [x] employee_seniority migration — Reviewed Schema Contract sections B/D/L; added tenant_staff.employee_seniority table with composite PK (tenant_id, id), RLS policies (5), indexes (employee_id, tenant_id+employee_id+effective_at DESC), standard triggers (update timestamp, prevent tenant mutation, audit), REPLICA IDENTITY for real-time, and FK to tenant_staff.employees. Supports employee seniority tracking with level (junior/mid/senior/lead/executive), rank (numeric for sorting), effective_at (historical tracking), and soft deletes. Added employee_seniority model to Prisma schema.prisma. Added tenant_staff.employee_seniority entry to Schema Registry v2.txt.
- [x] 20260124000000_labor_budget_tracking.sql — Reviewed Schema Contract sections B/D/E/G/K/L; added tenant_staff.labor_budgets and tenant_staff.budget_alerts tables with composite PKs (tenant_id, id), RLS policies (5 each), all required indexes (tenant+location, tenant+event, tenant+period for budgets; tenant+budget, tenant+alert_type, acknowledged for alerts), standard triggers (update timestamp, prevent tenant mutation, audit), REPLICA IDENTITY for real-time, and FK constraints to platform.accounts. Supports labor budget tracking with budget types (event/week/month), budget units (hours/cost), period-based budgets, configurable threshold alerts (80%/90%/100%), acknowledgment workflow, and override reason tracking. Prisma models LaborBudget and BudgetAlert added to schema.prisma. Added tenant_staff.labor_budgets and tenant_staff.budget_alerts entries to Schema Registry v2.txt.
- [x] 20260125000000_warehouse_shipment_tracking.sql — Reviewed Schema Contract sections B/D/G/K/L; added tenant_inventory.shipments and tenant_inventory.shipment_items tables with composite PKs (tenant_id, id), RLS policies (5 each), all required indexes (tenant+status, tenant+event, tenant+supplier, tracking_number for shipments; tenant+shipment, tenant+item, tenant+lot for items), standard triggers (update timestamp, prevent tenant mutation, audit), REPLICA IDENTITY for real-time, and FK constraints to tenant_events.events, tenant_inventory.inventory_suppliers, tenant_locations, tenant_inventory.inventory_items. Added public.shipment_status enum with values: draft, scheduled, preparing, in_transit, delivered, returned, cancelled. Supports outbound shipment tracking with packing lists, delivery status, and confirmation. Prisma models Shipment and ShipmentItem added to schema.prisma. Added public.shipment_status enum, tenant_inventory.shipments, and tenant_inventory.shipment_items entries to Schema Registry v2.txt.
- [x] packages/database/prisma/migrations/20260128000000_move_public_objects/migration.sql — Reviewed Schema Contract sections A/F; moved OutboxEvent and Tenant tables out of public, moved internal enums to core, updated Schema Registry v2.txt, and synced Prisma schema to remove public usage.
- [x] packages/database/prisma/migrations/20260201000000_event_detail_fields/migration.sql — Reviewed Schema Contract sections B/D/G/L; updated tenant_events.events with ticket_price, ticket_tier, event_format, accessibility_options, featured_media_url; Schema Registry updated; Prisma schema aligned.
- [x] packages/database/prisma/migrations/20260126145500_add_menu_models/migration.sql — Reviewed Schema Contract sections B/M; aligned menus/menu_dishes id columns to UUID with gen_random_uuid defaults so FK constraints match Prisma schema.
- [x] packages/database/prisma/migrations/20260203000000_recipe_version_base_fields/migration.sql — Reviewed Schema Contract sections B/D/H/L; updated Schema Registry recipe_versions entry; confirmed Prisma model sync for versioned base fields (name/category/cuisine/description/tags).
- [x] packages/database/prisma/migrations/20260203214030_repair_drift/migration.sql — Reviewed Schema Contract sections A/B/D; checked Schema Registry v2 for tenant_events and related schemas; generated additive repair migration via Prisma migrate diff (DB → schema) to resolve drift (including event_imports.file_type).
- [x] packages/database/prisma/migrations/20260203220243_repair_drift/migration.sql — Reviewed Schema Contract section B; index-only drift repair (event_reports_event_id_idx) generated via Prisma diff (DB → schema).
- [x] packages/database/prisma/migrations/20260205000000_admin_tasks/migration.sql — Reviewed Schema Contract sections B/D/L; added tenant_admin.admin_tasks to Schema Registry v2.txt; Prisma AdminTask model added; included RLS policies, standard triggers (update timestamp, prevent tenant mutation), and required tenant/status/due/active indexes.
- [x] packages/database/prisma/migrations/20260206023831_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; added tenant_admin.admin_chat_threads, admin_chat_participants, and admin_chat_messages to Schema Registry v2.txt; Prisma models added/validated; included RLS policies, standard triggers (update timestamp, prevent tenant mutation), and tenant/thread/user/active indexes for persistent admin chat threads and messages.
- [x] OverrideAudit model addition — Added tenant_kitchen.override_audit table for constraint override audit trail; supports entityType/entityId tracking with constraintId, guardExpression, overriddenBy, overrideReason, authorizedBy, authorizedAt; composite PK (tenantId, id), RLS policies, indexes for tenant lookups; Prisma OverrideAudit model added to schema.prisma; API route at apps/app/app/api/kitchen/overrides/route.ts; will require migration for OverrideAudit table.
- [x] packages/database/prisma/migrations/20260207093019_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; fixed OverrideAudit field naming to use @map("tenant_id") per schema rules; added tenant_kitchen.override_audit and confirmed tenant_kitchen.stations in Schema Registry v2.txt; Prisma schema aligned with camelCase → snake_case mapping; DROPPED ALL UNUSED RLS POLICIES (admin_tasks, admin_chat_threads, admin_chat_participants, admin_chat_messages); disabled RLS and removed triggers for admin tables (Clerk handles auth at application level, not database RLS); made prep_list_items.station_id nullable; repair migration includes both schema drift fixes AND RLS cleanup.
- [x] packages/database/prisma/migrations/20260208192422_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; added entity_id UUID and entity_type TEXT columns to tenant_events.command_board_cards for proper entity linking; added composite index on entity_id+entity_type for efficient entity lookups; additive changes only, nullable fields to maintain backward compatibility.
- [x] packages/database/prisma/migrations/20260212021746_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; added vector_clock JSONB and version INTEGER NOT NULL DEFAULT 0 columns to tenant_events.command_board_cards for conflict detection and optimistic locking; additive changes only; updated schema-registry-v2.txt entry; Prisma CommandBoardCard model already in sync with new fields.



- [x] packages/database/prisma/migrations/20260208100510_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; added tenant_events.command_board_groups table and group_id column to tenant_events.command_board_cards; confirmed entries in Schema Registry v2.txt; Prisma CommandBoardGroup model added with composite PK (tenant_id, id), optional groupId FK on CommandBoardCard with SetNull relation, and group-card bidirectional relation; additive changes only (new table, column, indexes).
- [x] packages/database/prisma/migrations/20260208111756_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; added tenant_events.command_board_connections table for manual connection management between cards; composite PK (tenant_id, id), board/fromCard/toCard FK constraints, unique index to prevent duplicate connections per board; additive changes only (new table with indexes).
- [x] packages/database/prisma/migrations/20260211001758_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; added tenant_staff.timecard_approvals and tenant_staff.approval_history to Schema Registry v2.txt; confirmed Prisma models TimecardApproval and ApprovalHistory with composite PKs (tenant_id, id), indexes (payroll_run_id, employee_id, status for timecard_approvals; entity_type+entity_id, performed_by for approval_history). Supports timecard approval workflow with submission, approval, rejection, and review tracking, plus comprehensive audit trail for all approval actions across payroll and timecards. Migration applied successfully to Neon database.

- [x] packages/database/prisma/migrations/20260211000000_add_user_preferences/migration.sql — Reviewed Schema Contract sections B/D/L; added tenant_staff.user_preferences table to Schema Registry v2.txt; confirmed Prisma UserPreference model with composite PK (tenant_id, id), unique constraint on (tenant_id, user_id, preference_key, category) WHERE deleted_at IS NULL, indexes (tenant_id, category), and FKs to platform.accounts and tenant_staff.employees. Supports user-specific preferences for cross-device sync with JSONB preference values, category-based organization, and soft deletes. Migration ready to apply.

- [x] packages/database/prisma/migrations/20260212031131_repair_drift/migration.sql — Auto-generated repair migration via db:repair; added tenant_staff.user_preferences table with CREATE TABLE IF NOT EXISTS, PK (tenant_id, id), indexes (tenant_id, category) and unique index (tenant_id, user_id, preference_key, category), plus FK constraints to platform.accounts and tenant_staff.employees. Migration ready to apply.
- [x] packages/database/prisma/migrations/20260213024733_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; auto-generated repair migration to add missing unique index on user_preferences table (tenant_id, user_id, preference_key, category); additive-only changes; Prisma schema already in sync.
- [x] packages/database/prisma/migrations/20260215092850_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; repair drift from P0-1 (cuid→gen_random_uuid for Menu, MenuDish, OutboxEvent) and P0-2 (16 FK indexes); additive changes only; Prisma schema updated in b07da288e.
- [x] packages/database/prisma/migrations/20260215094000_fix_outboxevent_id/migration.sql — Manual fix: OutboxEvent.id was text (cuid) instead of UUID; dropped and recreated with gen_random_uuid() default.
- [x] packages/database/prisma/migrations/20260215171352_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/L; changed auth_user_id from global UNIQUE to composite UNIQUE (tenant_id, auth_user_id) on tenant_staff.employees to support multi-org (same Clerk user can be employee in multiple tenants); updated schema-registry-v2.txt entry; Prisma schema already has @@unique([tenantId, authUserId], map: "employees_tenant_auth_user_idx"); migration drops old global index and creates new composite index.
- [x] packages/database/prisma/migrations/20260216074601_repair_drift/migration.sql — Reviewed Schema Contract sections B/D/G/L; command board redesign migration: added EntityType enum to tenant_events schema; created board_projections table (composite PK, unique constraint on board_id+entity_type+entity_id, indexes on board_id and entity_type+entity_id, FK to command_boards CASCADE, FK to command_board_groups SET NULL); created notes table (composite PK, tenant isolation index); created board_annotations table (composite PK, board_id index, FK to command_boards CASCADE); added scope JSONB and auto_populate BOOLEAN columns to command_boards; all FKs added via idempotent DO blocks; tenant isolation indexes added for all new tables; schema-registry-v2.txt updated with all new entries.

- [ ] packages/database/prisma/migrations/YYYYMMDDHHMMSS_add_sentry_fix_jobs/migration.sql — Reviewed Schema Contract sections B/D/L; added core.SentryFixJobStatus enum ('queued', 'running', 'succeeded', 'failed', 'cancelled') and platform.sentry_fix_jobs table for Sentry-to-PR auto-fixer pipeline; composite PK (id), UNIQUE on sentry_issue_id, indexes on (status, created_at) and (sentry_issue_id, created_at); supports webhook deduplication, rate limiting, job retry with max_retries, PR tracking with branch_name/pr_url/pr_number, error tracking with error_message; schema-registry-v2.txt updated with enum and table entries; Prisma SentryFixJob model and SentryFixJobStatus enum added to schema.prisma; migration pending generation.

