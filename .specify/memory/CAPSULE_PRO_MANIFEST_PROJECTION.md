# Capsule-Pro Manifest Projection Contract

**Version:** 0.1.0 (Pilot)
**Status:** Experimental - Single entity pilot for validation
**Last Updated:** 2026-02-06

---

## Overview

This document defines the **Capsule-Pro projection** - a code generator that emits Next.js App Router Route Handlers for Manifest entities, using Capsule-Pro's existing architecture (Prisma, auth patterns, response utilities).

**Important Distinction:**
- **Manifest** (the language) - IR-first, code generation is optional
- **Capsule-Pro** (the application) - Chooses to generate certain routes per this policy

This is a **Capsule-Pro architectural decision**, not a Manifest language requirement.

---

## What Gets Generated

**Scope**: Route handlers ONLY for Manifest entities under `app/api/kitchen/manifest/`

**Generated Artifacts**:
1. Route handler (`route.ts`) - Next.js App Router with HTTP method exports
2. Uses existing PrismaStore adapters (no new store code)
3. Uses existing auth/context helpers (no new auth code)
4. Uses existing response utilities (no new response types)

**NOT Generated**:
- Stores (use existing PrismaStore adapters)
- Auth (use existing `@repo/auth/server` patterns)
- Response utilities (use existing `@repo/kitchen-ops/api-response.ts`)
- Database migrations (use existing Prisma workflow)
- Frontend code (use existing patterns)

---

## File Locations

```
apps/app/app/api/kitchen/manifest/
├── recipes/
│   ├── route.ts           (generated or manual)
│   └── [id]/
│       └── route.ts       (generated or manual)
├── dishes/
│   └── route.ts           (generated or manual)
├── menus/
│   └── route.ts           (generated or manual)
└── ...
```

**Pattern**: `app/api/kitchen/manifest/{entity}/route.ts`

---

## Generated Header

All generated files MUST include this header at the top:

```typescript
// @generated
// Generated by Capsule-Pro Manifest Generator v0.1.0
// DO NOT EDIT - Changes will be overwritten
// Source manifest: packages/kitchen-ops/manifests/{entity}.manifest
// Generator: packages/manifest/src/generators/capsule-pro.ts
//
// Escape hatch: Create a manual route in a sibling directory and import
// the generated handler as a helper function.
```

---

## Escape Hatch

If you need custom logic for a generated route:

**Option 1: Wrapper Pattern**
```typescript
// app/api/kitchen/manifest-v2/recipes/route.ts (manual)
import { generatedListRecipes } from '../../manifest/recipes/list-handler';
import { auth } from '@repo/auth/server';

export async function GET(request: Request) {
  // Your custom logic here
  const result = await generatedListRecipes(request);
  // Post-process result
  return result;
}
```

**Option 2: Override Pattern**
- Create manual route at a different path
- Don't use the generator for that entity

---

## Stability Guarantees

**Version 0.1.0 (Pilot)**:
- No stability guarantees - experimental pilot for validation
- Breaking changes may occur at any time
- **DO NOT** use in production until validated and stabilized

**Future Versions**:
- Semantic versioning for generator output
- Breaking changes require explicit migration path
- Generator version embedded in generated header

---

## Generated Route Handler Pattern

### Template

```typescript
// @generated
// Generated by Capsule-Pro Manifest Generator v{version}
// DO NOT EDIT - Changes will be overwritten

import { auth } from "@repo/auth/server";
import { database } from "@repo/database";
import { create{Entity}Runtime, type KitchenOpsContext } from "@repo/kitchen-ops";
import { NextResponse } from "next/server";
import { getTenantIdForOrg } from "@/app/lib/tenant";
import { createPrismaStoreProvider } from "@repo/kitchen-ops/prisma-store";
import { manifestErrorResponse, manifestSuccessResponse } from "@repo/kitchen-ops/api-response";

/**
 * Generated route handler for {Entity} {operation}
 *
 * Generated from: packages/kitchen-ops/manifests/{entity}.manifest
 */
export async function {METHOD}(request: Request) {
  // 1. Auth check
  const { orgId } = await auth();
  if (!orgId) {
    return manifestErrorResponse(new Error("Unauthorized"), 401);
  }

  // 2. Tenant resolution
  const tenantId = await getTenantIdForOrg(orgId);

  // 3. Get current user
  const currentUser = await database.user.findFirst({
    where: {
      AND: [{ tenantId }, { authUserId: (await auth()).userId ?? "" }],
    },
  });

  if (!currentUser) {
    return manifestErrorResponse(new Error("User not found"), 400);
  }

  // 4. Create runtime context
  const runtimeContext: KitchenOpsContext = {
    tenantId,
    userId: currentUser.id,
    userRole: currentUser.role,
    storeProvider: createPrismaStoreProvider(database, tenantId),
  };

  // 5. Create runtime
  const runtime = await create{Entity}Runtime(runtimeContext);

  // 6. Execute operation
  try {
    {OPERATION_LOGIC}

    return manifestSuccessResponse({RESULT});
  } catch (error) {
    return manifestErrorResponse(error);
  }
}
```

---

## Response Handling

Use existing response utilities from `@repo/kitchen-ops/api-response.ts`:

```typescript
import { manifestErrorResponse, manifestSuccessResponse } from "@repo/kitchen-ops/api-response";

// Success
return manifestSuccessResponse({
  id: recipeId,
  name: "Recipe Name",
  // ... other fields
});

// Error
return manifestErrorResponse(error, statusCode?);
```

---

## Constraint Enforcement

**Critical**: Runtime operations MUST check constraint outcomes:

```typescript
// Entity creation - check for undefined (constraint failure)
const result = await runtime.createInstance("Recipe", data);
if (!result) {
  // Constraint failed - return 400 with diagnostics
  return manifestErrorResponse(
    new Error("Constraint validation failed"),
    400,
    { constraintFailures: runtime.getDiagnostics() }
  );
}

// Command execution - check constraintOutcomes
const commandResult = await runtime.executeCommand(
  recipeId,
  "update",
  params
);

if (commandResult.constraintOutcomes?.some(c => !c.passed && c.severity === 'block')) {
  return manifestErrorResponse(
    new Error("Command blocked by constraint"),
    400,
    { constraintOutcomes: commandResult.constraintOutcomes }
  );
}
```

---

## Generator Implementation

**Location**: `packages/manifest/src/generators/capsule-pro.ts`

**Function**:
```typescript
export function generateCapsuleProRouteHandlers(
  entityName: string,
  operations: RouteOperation[]
): string {
  // Generate route.ts content
}
```

**Inputs**:
- Entity name from IR
- Operations to generate (list, get, create, update, delete, command)

**Outputs**:
- Generated TypeScript code for route.ts

---

## Pilot Scope

**Entity**: Recipe
**Operations**:
1. `GET /api/kitchen/manifest/recipes` - List all recipes
2. `POST /api/kitchen/manifest/recipes` - Create recipe (already exists manually)

**Validation Goals**:
- Auth/context injection works
- Request parsing works
- Runtime execution works
- Constraint/guard diagnostics flow through
- Persistence through PrismaStore works
- Response formatting matches existing patterns

**Success Criteria**:
- Generated route works end-to-end
- Tests pass
- No manual Prisma sync needed
- Constraint failures return proper diagnostics

---

## Migration Path (Future)

After pilot validation:

1. **Phase 1**: Generate new entity routes only
2. **Phase 2**: Migrate existing manual routes one at a time
3. **Phase 3**: Add blocking enforcement for NEW routes
4. **Phase 4**: Add blocking enforcement for EXISTING routes (after migration)

**Non-blocking inventory test** will track migration progress.

---

## Testing

**Unit Tests**:
- Test generator output for each entity
- Test generated routes with Vitest

**Integration Tests**:
- Test routes against actual database
- Test constraint enforcement
- Test auth/authz

**Conformance Tests**:
- Ensure generated routes match IR semantics
- Ensure runtime behavior matches manifest spec

---

## References

- **Next.js Route Handlers**: https://nextjs.org/docs/app/getting-started/route-handlers
- **Prisma CRUD**: https://www.prisma.io/docs/orm/prisma-client/queries/crud
- **Vitest**: https://vitest.dev/guide/
- **Existing Manual Integration**: `apps/app/app/api/kitchen/manifest/recipes/route.ts`
- **PrismaStore Adapters**: `packages/kitchen-ops/src/prisma-store.ts`
- **Response Utilities**: `packages/kitchen-ops/src/api-response.ts`

---

## Version History

- **0.1.0** (2026-02-06) - Initial pilot contract for Recipe entity validation
