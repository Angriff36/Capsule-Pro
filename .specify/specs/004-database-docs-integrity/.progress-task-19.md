## Completed Tasks
- [x] T019 [P] Document OutboxEvent table + fix types - TASK_COMPLETE

## Current Task
Awaiting next task

## Learnings

### T019: OutboxEvent Documentation

#### Critical Issues Found
1. **Missing Foreign Key to Account**
   - `tenantId` column has no FK constraint to `platform.Account.id`
   - Cannot guarantee referential integrity at database level
   - Application-layer validation only
   - Migration TODO: Add FK constraint with ON DELETE CASCADE

2. **Naming Inconsistency (camelCase vs snake_case)**
   - OutboxEvent uses `tenantId` without `@map("tenant_id")`
   - Other tenant tables use `@map("tenant_id")` for consistency
   - Database column is actually `tenantId` instead of `tenant_id`
   - Migration TODO: Rename column to `tenant_id` and add `@map` annotation

3. **Schema Location**
   - Currently in `tenant` schema but should be in `core` or `public`
   - OutboxEvent is infrastructure plumbing, not domain data
   - Priority: Low (requires careful migration planning)

#### Outbox Pattern Implementation
- **Purpose**: Transactional event publishing to Ably
- **Flow**: Domain write + outbox event creation in same transaction → background worker publishes to Ably
- **Status enum**: pending, published, failed
- **Worker polling**: `WHERE status = 'pending' ORDER BY createdAt ASC`
- **Priority order**: Kitchen tasks (highest) → Events/Boards → Scheduling

#### Type Safety Audit
- **No `any` types found** in outbox-related code
- `CreateOutboxEventInput` properly typed with `Record<string, unknown>` for payload
- `createOutboxEvent` helper uses Prisma types correctly
- Tenant scoping working via `createTenantClient` extension

#### Files Reviewed
- `packages/database/prisma/schema.prisma` (OutboxEvent model definition)
- `packages/realtime/src/outbox/create.ts` (type-safe helper function)
- `packages/realtime/src/outbox/index.ts` (exports)
- `packages/database/tenant.ts` (tenant scoping via Prisma extension)
- `apps/api/app/outbox/publish/route.ts` (background worker)
- `apps/app/app/(authenticated)/kitchen/tasks/actions.ts` (usage example)

#### Column Details
- `id`: CUID (collision-resistant, sortable)
- `tenantId`: String (ISSUE: missing FK to Account)
- `eventType`: Dot-notation (e.g., "kitchen.task.claimed")
- `aggregateType`: Domain type (e.g., "KitchenTask", "Event")
- `aggregateId`: Specific instance ID
- `payload`: JSON (flexible structure per event type)
- `status`: OutboxStatus enum (pending/published/failed)
- `error`: String (nullable, for failed publications)
- `createdAt`: DateTime (event creation timestamp)
- `publishedAt`: DateTime (nullable, set on successful publish)

#### Indexes
- Composite index on `(status, createdAt)` for worker polling
- Index on `tenantId` for tenant filtering
- Composite index on `(aggregateType, aggregateId)` for event replay

#### Usage Examples Documented
1. Kitchen task claim with event creation
2. Battle board update with event creation
3. Background worker polling and publishing
4. Real-time client subscription via Ably

#### Migration TODOs Documented
```sql
-- TODO 1: Add FK constraint
ALTER TABLE tenant.OutboxEvent
ADD CONSTRAINT fk_outboxevent_tenantid
FOREIGN KEY (tenantId)
REFERENCES platform.Account(id)
ON DELETE CASCADE;

-- TODO 2: Rename column to snake_case
ALTER TABLE tenant.OutboxEvent
RENAME COLUMN tenantId TO tenant_id;

-- TODO 3: Implement archival for old published events
DELETE FROM tenant.OutboxEvent
WHERE status = 'published'
AND publishedAt < NOW() - INTERVAL '30 days';
```

## Next
Task T020 or next pending task in sequence
