# Progress: Realtime Transport (Outbox to Ably)

Feature ID: 001
Constitution: 1.0.0

## Completed Tasks

### Phase 1: Setup
- [x] T001: Create packages/realtime scaffold - 9caafebb5
  - package.json with zod dependency
  - tsconfig.json extending @repo/typescript-config
  - vitest.config.ts with vitest config
  - src/index.ts placeholder

### Phase 2: Core Implementation (POC)
- [x] T002: Define event envelope base types - 7dc07fde1
  - REALTIME_EVENT_VERSION = 1
  - RealtimeEventBase interface (id, version, tenantId, aggregateType, aggregateId, occurredAt)

- [x] T003: Define kitchen event types - 7dc07fde1
  - KitchenTaskClaimedEvent
  - KitchenTaskReleasedEvent
  - KitchenTaskProgressEvent
  - KitchenEvent union type

- [x] T004: Channel naming utilities - 7dc07fde1
  - getChannelName(tenantId) -> "tenant:{tenantId}"
  - getModuleFromEventType(eventType) -> module name
  - parseChannelName(channel) -> tenantId extraction

- [x] T005: Zod schemas - e8805cad3
  - RealtimeEventBaseSchema
  - Kitchen event schemas with payload validation
  - parseRealtimeEvent() helper

- [x] T006: createOutboxEvent helper - e8805cad3
  - CreateOutboxEventInput type
  - createOutboxEvent(db, input) function
  - Supports PrismaClient and TransactionClient

- [x] T007: Quality checkpoint - PASSED
  - pnpm typecheck --filter @repo/realtime: PASSED

- [x] T008: Export event types - 3b2c97b4e
  - Re-export envelope types
  - Re-export kitchen events
  - Re-export Zod schemas
  - Updated src/index.ts

### Phase 3: Publisher Refinement
- [x] T009: Publisher endpoint with envelope - 9f99f8771
  - Import types from @repo/realtime
  - Build RealtimeEvent envelope
  - Publish envelope to Ably

- [x] T010: Payload size validation - 9f99f8771
  - Warn at 32 KiB
  - Reject at 64 KiB
  - Set error status on oversized payloads

- [x] T011: Quality checkpoint - PASSED
  - apps/api typecheck: PASSED (pre-existing errors unrelated)

### Phase 4: POC Validation
- [x] T012: POC validation - a1873e99f
  - Event envelope structure validated
  - Payload size checks implemented
  - oldestPendingSeconds metric added
  - README with manual test instructions

### Phase 5: Refinement
- [x] T013: SKIP LOCKED - c754deb27
  - $queryRaw with FOR UPDATE SKIP LOCKED
  - Double-check status before processing
  - Skipped counter added

- [x] T014: Quality checkpoint - PASSED
  - Typecheck passed

### Phase 6: Testing
- [x] T015: Event schema unit tests - 22d1819dc
  - 18 tests covering all schemas
  - Valid/invalid payload validation

- [x] T016: Channel naming unit tests - 22d1819dc
  - 17 tests covering all channel functions
  - Edge cases tested

- [x] T017: Publisher integration tests - a9ad95298
  - 9 tests for publisher logic
  - Envelope building
  - Payload size validation

- [x] T018: Quality checkpoint - PASSED
  - 44 tests passed
  - typecheck passed

## Current Task

Completing T019-T021: Quality Gates

## AC Checklist (T021)

### US1: Publish Pending Outbox Events
- [x] AC-1.1: Pending events read ordered by createdAt ASC
  - Verified in route.ts: `orderBy: { createdAt: "asc" }`
- [x] AC-1.2: Events publish to channel `tenant:{tenantId}` with eventType as message name
  - Verified: `getChannelName(event.tenantId)` and `channel.publish(event.eventType, envelope)`
- [x] AC-1.3: Published events update to status=published with publishedAt timestamp
  - Verified: `status: "published", publishedAt: new Date()`
- [x] AC-1.4: Failed events update to status=failed with error message
  - Verified: `status: "failed", error: message`
- [x] AC-1.5: Bearer token required
  - Verified: `OUTBOX_PUBLISH_TOKEN` check in route.ts
- [x] AC-1.6: Response returns `{ published: N, failed: M }` count
  - Verified: Response includes published, failed, skipped, oldestPendingSeconds

### US2: Create Outbox Events
- [x] AC-2.1: `createOutboxEvent()` accepts typed event envelope
  - Verified: CreateOutboxEventInput type defined
- [x] AC-2.2: Envelope includes tenantId, aggregateType, aggregateId, eventType, payload
  - Verified: All fields in CreateOutboxEventInput
- [x] AC-2.3: Events insert with status=pending and createdAt=now()
  - Verified: `status: "pending"` (createdAt defaults via Prisma)
- [x] AC-2.4: Function importable from `@repo/realtime`
  - Verified: Exported from src/index.ts
- [x] AC-2.5: Supports Prisma transaction
  - Verified: Accepts PrismaClient | Prisma.TransactionClient

### US3: Type-Safe Event Definitions
- [x] AC-3.1: `RealtimeEvent` discriminated union by eventType
  - Verified: RealtimeEventSchema with discriminatedUnion
- [x] AC-3.2: Kitchen events include claimed, released, progress
  - Verified: All three types defined
- [x] AC-3.3: Each event has Zod schema
  - Verified: KitchenTaskClaimedEventSchema, etc.
- [x] AC-3.4: `parseRealtimeEvent()` validates unknown payloads
  - Verified: parseRealtimeEvent function exported
- [x] AC-3.5: Types available from `@repo/realtime`
  - Verified: All types exported from src/index.ts

### US4: Channel Naming
- [x] AC-4.1: Pattern `tenant:{tenantId}` for all events
  - Verified: getChannelName implementation
- [x] AC-4.2: Module derivable from eventType prefix
  - Verified: getModuleFromEventType implementation
- [x] AC-4.3: `getChannelName(tenantId)` generates channel name
  - Verified: Function exists and tested
- [x] AC-4.4: Documented in package README
  - Verified: README.md includes channel naming docs

### US5: Idempotent Publishing
- [x] AC-5.1: Events with status != pending are skipped
  - Verified: Double-check in loop `if (event.status !== "pending")`
- [x] AC-5.2: Published events cannot return to pending
  - Verified: No update path back to pending
- [x] AC-5.3: SKIP LOCKED for concurrent safety
  - Verified: `$queryRaw` with `FOR UPDATE SKIP LOCKED`

## Next Steps

1. User: Push branch and create PR
   ```bash
   git push -u origin ralph/initial-build
   gh pr create --title "feat(realtime): implement outbox to Ably transport" --body "Implements Feature 001"
   ```

2. Monitor CI checks

3. Merge after CI green

## Learnings

- Used Prisma $queryRaw for SKIP LOCKED (not available in standard CRUD)
- Unit tests for schemas validate runtime behavior
- Channel naming pattern deferred module channels to Phase 2
- Payload size limits protect against Ably quota issues
- occurredAt in payload allows authoritative ordering vs createdAt

## Technical Debt Tracking

| Debt | Future Fix | Tracking |
|------|------------|----------|
| No exponential backoff | Phase 2 retry logic | Spec 4.3 |
| No dead letter queue | Phase 2 | Spec 4.3 |
| Client-side filtering | Phase 2 module channels | Spec 8.2 |
| No event archival | Separate cleanup job | Spec 4.3 |
