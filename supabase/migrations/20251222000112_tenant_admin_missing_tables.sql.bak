-- Create missing admin_users table without complex FK constraints
-- This follows the same pattern as the successful admin_permissions table

CREATE TABLE tenant_admin.admin_users (
  tenant_id uuid NOT NULL DEFAULT '00000000-0000-0000-0000-000000000000'::uuid,
  id uuid DEFAULT gen_random_uuid(),
  auth_user_id uuid NOT NULL,
  role uuid NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  last_login timestamptz,
  last_failed_login timestamptz,
  failed_login_attempts smallint DEFAULT 0,
  locked_until timestamptz,
  two_factor_enabled boolean NOT NULL DEFAULT false,
  two_factor_secret text,
  login_ip text,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  deleted_at timestamptz NULL,
  PRIMARY KEY (tenant_id, id),
  UNIQUE (tenant_id, auth_user_id),
  CHECK (is_active IN (true, false)),
  CHECK (last_login IS NULL OR last_login < now()),
  CHECK (last_failed_login IS NULL OR last_failed_login < now()),
  CHECK (failed_login_attempts >= 0 AND failed_login_attempts <= 10),
  CHECK (locked_until IS NULL OR locked_until > now()),
  CHECK (two_factor_enabled IN (true, false)),
  CHECK (two_factor_secret IS NULL OR length(trim(two_factor_secret)) <= 100),
  CHECK (login_ip IS NULL OR login_ip ~* '^([0-9]{1,3}\.){3}[0-9]{1,3}$' OR login_ip ~* '^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$')
);

-- Indexes
CREATE INDEX admin_users_tenant_auth_user_idx
  ON tenant_admin.admin_users(tenant_id, auth_user_id) WHERE deleted_at IS NULL;

CREATE INDEX admin_users_tenant_role_idx
  ON tenant_admin.admin_users(tenant_id, role) WHERE deleted_at IS NULL;

CREATE INDEX admin_users_tenant_active_idx
  ON tenant_admin.admin_users(tenant_id, is_active) WHERE deleted_at IS NULL;

CREATE INDEX admin_users_tenant_last_login_idx
  ON tenant_admin.admin_users(tenant_id, last_login DESC) WHERE deleted_at IS NULL AND last_login IS NOT NULL;

CREATE INDEX admin_users_tenant_locked_idx
  ON tenant_admin.admin_users(tenant_id, locked_until)
  WHERE deleted_at IS NULL AND locked_until IS NOT NULL;

CREATE INDEX admin_users_auth_user_idx
  ON tenant_admin.admin_users(auth_user_id) WHERE auth_user_id IS NOT NULL;

-- Triggers
CREATE TRIGGER admin_users_update_timestamp
  BEFORE UPDATE ON tenant_admin.admin_users
  FOR EACH ROW EXECUTE FUNCTION core.fn_update_timestamp();

CREATE TRIGGER admin_users_prevent_tenant_mutation
  BEFORE UPDATE ON tenant_admin.admin_users
  FOR EACH ROW EXECUTE FUNCTION core.fn_prevent_tenant_mutation();

CREATE TRIGGER admin_users_audit_trigger
  AFTER UPDATE OR DELETE ON tenant_admin.admin_users
  FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trigger('admin_users', 'tenant_admin');

-- Row Level Security
ALTER TABLE tenant_admin.admin_users ENABLE ROW LEVEL SECURITY;

-- Create RLS policies
CREATE POLICY admin_users_select ON tenant_admin.admin_users
  FOR SELECT USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
  );

CREATE POLICY admin_users_insert ON tenant_admin.admin_users
  FOR INSERT WITH CHECK (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
  );

CREATE POLICY admin_users_update ON tenant_admin.admin_users
  FOR UPDATE USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
  ) WITH CHECK (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
  );

CREATE POLICY admin_users_delete ON tenant_admin.admin_users
  FOR DELETE USING (false);

CREATE POLICY admin_users_service ON tenant_admin.admin_users
  FOR ALL TO service_role USING (true) WITH CHECK (true);

-- Admin user audit trail table
CREATE TABLE tenant_admin.admin_audit_trail (
  tenant_id uuid NOT NULL DEFAULT '00000000-0000-0000-0000-000000000000'::uuid,
  id uuid DEFAULT gen_random_uuid(),
  admin_user_id uuid NOT NULL,
  action text NOT NULL,
  entity_type text NOT NULL,
  entity_id uuid,
  changes jsonb,
  old_values jsonb,
  new_values jsonb,
  ip_address inet,
  user_agent text,
  session_id uuid,
  created_at timestamptz NOT NULL DEFAULT now(),
  PRIMARY KEY (tenant_id, id),
  -- Audit action types
  CHECK (action IN (
    'login', 'logout', 'create', 'update', 'delete', 'view', 'permission_change',
    'role_change', 'account_change', 'security_change'
  )),
  -- Entity types that can be audited
  CHECK (entity_type IN (
    'admin_users', 'admin_roles', 'admin_permissions', 'admin_audit_trail',
    'users', 'roles', 'permissions', 'tenants', 'reports', 'settings'
  )),
  CHECK (length(trim(action)) <= 50),
  CHECK (length(trim(entity_type)) <= 50),
  CHECK (entity_id IS NULL OR (entity_id <> '00000000-0000-0000-0000-000000000000'::uuid)),
  CHECK (changes IS NULL OR jsonb_typeof(changes) IN ('object', 'array', 'string', 'number', 'boolean')),
  CHECK (old_values IS NULL OR jsonb_typeof(old_values) IN ('object', 'array', 'string', 'number', 'boolean')),
  CHECK (new_values IS NULL OR jsonb_typeof(new_values) IN ('object', 'array', 'string', 'number', 'boolean')),
  CHECK (user_agent IS NULL OR length(trim(user_agent)) <= 500),
  CHECK (session_id IS NULL OR (session_id <> '00000000-0000-0000-0000-000000000000'::uuid)),
  CHECK (
    -- For certain actions, entity_id is required
    (action IN ('create', 'update', 'delete') AND entity_id IS NOT NULL) OR
    -- For authentication actions, entity_id can be NULL
    (action IN ('login', 'logout', 'permission_change', 'role_change', 'account_change', 'security_change') AND entity_id IS NULL) OR
    -- For view actions, entity_id can be NULL (e.g., viewing a list)
    (action = 'view' AND entity_id IS NULL)
  ),
  CHECK (
    -- For create/update/delete actions, changes should contain the old_values/new_values
    (action IN ('create', 'update', 'delete') AND (old_values IS NOT NULL OR new_values IS NOT NULL)) OR
    -- For other actions, changes or old_values/new_values can be provided but aren't required
    (NOT action IN ('create', 'update', 'delete'))
  )
);

-- Indexes for admin_audit_trail
CREATE INDEX admin_audit_trail_tenant_admin_user_idx
  ON tenant_admin.admin_audit_trail(tenant_id, admin_user_id);

CREATE INDEX admin_audit_trail_tenant_action_idx
  ON tenant_admin.admin_audit_trail(tenant_id, action);

CREATE INDEX admin_audit_trail_tenant_entity_idx
  ON tenant_admin.admin_audit_trail(tenant_id, entity_type);

CREATE INDEX admin_audit_trail_tenant_entity_id_idx
  ON tenant_admin.admin_audit_trail(tenant_id, entity_type, entity_id)
  WHERE entity_id IS NOT NULL;

CREATE INDEX admin_audit_trail_tenant_created_idx
  ON tenant_admin.admin_audit_trail(tenant_id, created_at DESC);

CREATE INDEX admin_audit_trail_admin_user_idx
  ON tenant_admin.admin_audit_trail(admin_user_id) WHERE admin_user_id IS NOT NULL;

CREATE INDEX admin_audit_trail_action_entity_idx
  ON tenant_admin.admin_audit_trail(action, entity_type)
  WHERE deleted_at IS NULL;

-- Triggers for admin_audit_trail
CREATE TRIGGER admin_audit_trail_update_timestamp
  BEFORE UPDATE ON tenant_admin.admin_audit_trail
  FOR EACH ROW EXECUTE FUNCTION core.fn_update_timestamp();

CREATE TRIGGER admin_audit_trail_prevent_tenant_mutation
  BEFORE UPDATE ON tenant_admin.admin_audit_trail
  FOR EACH ROW EXECUTE FUNCTION core.fn_prevent_tenant_mutation();

CREATE TRIGGER admin_audit_trail_audit_trigger
  AFTER UPDATE OR DELETE ON tenant_admin.admin_audit_trail
  FOR EACH ROW EXECUTE FUNCTION core.fn_audit_trigger('admin_audit_trail', 'tenant_admin');

-- Row Level Security
ALTER TABLE tenant_admin.admin_audit_trail ENABLE ROW LEVEL SECURITY;

-- Create RLS policies
CREATE POLICY admin_audit_trail_select ON tenant_admin.admin_audit_trail
  FOR SELECT USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
  );

CREATE POLICY admin_audit_trail_insert ON tenant_admin.admin_audit_trail
  FOR INSERT WITH CHECK (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
  );

CREATE POLICY admin_audit_trail_update ON tenant_admin.admin_audit_trail
  FOR UPDATE USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
  ) WITH CHECK (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
  );

CREATE POLICY admin_audit_trail_delete ON tenant_admin.admin_audit_trail
  FOR DELETE USING (false);

CREATE POLICY admin_audit_trail_service ON tenant_admin.admin_audit_trail
  FOR ALL TO service_role USING (true) WITH CHECK (true);

-- Update the existing policies to include function permissions
ALTER POLICY admin_roles_select ON tenant_admin.admin_roles
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
    AND tenant_admin.fn_has_permission('roles.view'::text)
  );

ALTER POLICY admin_roles_insert ON tenant_admin.admin_roles
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND tenant_admin.fn_has_permission('roles.create'::text)
  );

ALTER POLICY admin_roles_update ON tenant_admin.admin_roles
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
    AND tenant_admin.fn_has_permission('roles.update'::text)
  ) WITH CHECK (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
  );

ALTER POLICY admin_roles_delete ON tenant_admin.admin_roles
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
    AND tenant_admin.fn_has_permission('roles.delete'::text)
  );

ALTER POLICY admin_permissions_select ON tenant_admin.admin_permissions
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
    AND tenant_admin.fn_has_permission('permissions.view'::text)
  );

ALTER POLICY admin_permissions_insert ON tenant_admin.admin_permissions
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND tenant_admin.fn_has_permission('permissions.create'::text)
  );

ALTER POLICY admin_permissions_update ON tenant_admin.admin_permissions
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
    AND tenant_admin.fn_has_permission('permissions.update'::text)
  ) WITH CHECK (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
  );

ALTER POLICY admin_permissions_delete ON tenant_admin.admin_permissions
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
    AND tenant_admin.fn_has_permission('permissions.delete'::text)
  );

ALTER POLICY admin_users_select ON tenant_admin.admin_users
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
    AND tenant_admin.fn_has_permission('users.view'::text)
  );

ALTER POLICY admin_users_insert ON tenant_admin.admin_users
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND tenant_admin.fn_has_permission('users.create'::text)
  );

ALTER POLICY admin_users_update ON tenant_admin.admin_users
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
    AND tenant_admin.fn_has_permission('users.update'::text)
  ) WITH CHECK (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
  );

ALTER POLICY admin_users_delete ON tenant_admin.admin_users
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND deleted_at IS NULL
    AND tenant_admin.fn_has_permission('users.delete'::text)
  );

ALTER POLICY admin_audit_trail_select ON tenant_admin.admin_audit_trail
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND tenant_admin.fn_has_permission('audit.view'::text)
  );

ALTER POLICY admin_audit_trail_insert ON tenant_admin.admin_audit_trail
  USING (
    tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
    AND tenant_admin.fn_has_permission('audit.log'::text)
  );

-- Insert default admin users and audit trail entries
INSERT INTO tenant_admin.admin_users (
  tenant_id,
  id,
  auth_user_id,
  role,
  is_active,
  two_factor_enabled,
  created_at,
  updated_at
) VALUES (
  '00000000-0000-0000-0000-000000000000'::uuid,
  '00000000-0000-0000-0000-000000000001'::uuid,
  '00000000-0000-0000-0000-000000000002'::uuid,
  '00000000-0000-0000-0000-000000000003'::uuid,  -- super_admin role
  true,
  false,
  now(),
  now()
);

-- Verification queries
SELECT
  schemaname,
  tablename
FROM pg_tables
WHERE schemaname = 'tenant_admin'
ORDER BY tablename;

SELECT
  schemaname,
  tablename,
  indexname
FROM pg_indexes
WHERE schemaname = 'tenant_admin'
ORDER BY tablename, indexname;

SELECT
  schemaname,
  tablename,
  rowsecurity
FROM pg_class c
JOIN pg_namespace n ON c.relnamespace = n.oid
WHERE n.nspname = 'tenant_admin'
  AND c.relkind = 'r'
  AND has_table_privilege(c.oid, 'SELECT');

SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_schema = 'tenant_admin'
  AND routine_type = 'FUNCTION'
ORDER BY routine_name;

SELECT
  t.typname as enum_name,
  e.enumsortorder as enum_value
FROM pg_type t
  LEFT JOIN pg_enum e ON t.oid = e.enumtypid
WHERE t.typname IN ('admin_action', 'admin_entity_type', 'admin_role')
ORDER BY t.typname, e.enumsortorder;

SELECT
  table_name,
  (SELECT COUNT(*) FROM tenant_admin.table_name) as record_count
FROM information_schema.tables
WHERE table_schema = 'tenant_admin'
  AND table_name IN ('admin_users', 'admin_audit_trail');

-- Verify RLS policies
SELECT
  n.nspname as schema,
  c.relname as table,
  polname as policy,
  permissive,
  cmd,
  qual
FROM pg_policies pol
  JOIN pg_class c ON pol.tabrelid = c.oid
  JOIN pg_namespace n ON c.relnamespace = n.oid
WHERE n.nspname = 'tenant_admin'
ORDER BY c.relname, polname;

-- Test permission functions
SELECT
  'roles.view' as permission,
  tenant_admin.fn_has_permission('roles.view'::text) as can_view;

SELECT
  'users.delete' as permission,
  tenant_admin.fn_has_permission('users.delete'::text) as can_delete;