SCHEMA REGISTRY v2 (Enterprise Catering Platform)
==================================================
Last updated: 2025-01-15
Canonical source of truth for all database objects.
Update this file BEFORE generating any migration.

NOTE: This registry reflects the actual database state as of 2025-01-15.
All tables listed here exist in the Neon database migrations.

================================================================================
PLATFORM SCHEMA (no tenant_id)
================================================================================

platform.accounts
  id uuid PK
  name text NOT NULL
  slug text NOT NULL UNIQUE  -- URL-safe identifier
  default_timezone text NOT NULL DEFAULT 'UTC'
  week_start smallint NOT NULL DEFAULT 1
  subscription_tier text NOT NULL DEFAULT 'trial'
  subscription_status text NOT NULL DEFAULT 'active'
  max_locations smallint NOT NULL DEFAULT 1
  max_employees smallint NOT NULL DEFAULT 10
  created_at timestamptz NOT NULL DEFAULT now()
  updated_at timestamptz NOT NULL DEFAULT now()
  deleted_at timestamptz NULL
  -- NO tenant_id (this IS the tenant)

platform.audit_log (partitioned by month)
  id uuid DEFAULT gen_random_uuid()
  tenant_id uuid NULL  -- NULL for platform-level events
  table_schema text NOT NULL
  table_name text NOT NULL
  record_id uuid NOT NULL
  action core.action_type NOT NULL
  old_values jsonb
  new_values jsonb
  performed_by uuid  -- auth.users id
  ip_address inet
  user_agent text
  created_at timestamptz NOT NULL DEFAULT now()
  PK: (id, created_at)  -- for partitioning

platform.audit_archive (partitioned by year)
  -- Same schema as audit_log, populated by archival job

platform.sent_emails
  id uuid PK DEFAULT gen_random_uuid()
  tenant_id uuid NOT NULL REFERENCES platform.accounts(id) ON DELETE RESTRICT
  recipient_email text NOT NULL
  subject text NOT NULL
  correlation_id text  -- For idempotency (Inngest job tracking)
  sent_at timestamptz NOT NULL DEFAULT now()
  UNIQUE (tenant_id, correlation_id) WHERE correlation_id IS NOT NULL
  -- Purpose: Track sent emails for idempotency in background jobs (Inngest)
  -- Note: tenant_id present but this is platform-level tracking table

================================================================================
CORE SCHEMA (enums, functions, lookups - no tenant-scoped tables)
================================================================================

ENUMS (immutable only):
  core.action_type: 'insert', 'update', 'delete'
  core.employment_type: 'full_time', 'part_time', 'contractor', 'temp'
  core.unit_system: 'metric', 'imperial', 'custom'
  core.unit_type: 'volume', 'weight', 'count', 'length', 'temperature', 'time'

LOOKUP TABLES:

core.status_types
  id smallint PK
  category text NOT NULL  -- 'task', 'event', 'lead', 'payroll', 'claim', 'proposal'
  code text NOT NULL
  label text NOT NULL
  description text
  color_hex char(7)  -- UI hint
  sort_order smallint NOT NULL DEFAULT 0
  is_terminal boolean NOT NULL DEFAULT false
  is_default boolean NOT NULL DEFAULT false  -- Default for new records
  is_active boolean NOT NULL DEFAULT true
  UNIQUE (category, code)
  -- Seeded with standard statuses, tenants cannot modify (platform-level)

core.status_transitions
  id serial PK
  category text NOT NULL
  from_status_code text  -- NULL = initial state
  to_status_code text NOT NULL
  requires_role text[]  -- NULL = any role
  is_automatic boolean NOT NULL DEFAULT false  -- System-triggered
  UNIQUE (category, from_status_code, to_status_code)
  FK: (category, from_status_code) -> status_types
  FK: (category, to_status_code) -> status_types

core.units
  id smallint PK
  code text NOT NULL UNIQUE  -- 'ml', 'cup', 'g', 'oz', 'each'
  name text NOT NULL
  name_plural text NOT NULL
  unit_system core.unit_system NOT NULL
  unit_type core.unit_type NOT NULL
  is_base_unit boolean NOT NULL DEFAULT false  -- Base for conversions in type

core.unit_conversions
  from_unit_id smallint NOT NULL REFERENCES core.units
  to_unit_id smallint NOT NULL REFERENCES core.units
  multiplier numeric(20,10) NOT NULL  -- from * multiplier = to
  PK: (from_unit_id, to_unit_id)
  CHECK: from_unit_id != to_unit_id

core.audit_config
  table_schema text NOT NULL
  table_name text NOT NULL
  audit_level text NOT NULL DEFAULT 'full'  -- 'full', 'changes_only', 'status_only', 'none'
  excluded_columns text[]  -- Columns to exclude from audit (e.g., 'updated_at')
  PK: (table_schema, table_name)

core.waste_reasons
  id smallint PK
  code text NOT NULL UNIQUE
  name text NOT NULL
  description text
  color_hex char(7)  -- UI hint for charts/tags
  is_active boolean NOT NULL DEFAULT true
  sort_order smallint NOT NULL DEFAULT 0
  -- Seeded with: spoilage, overproduction, prep_error, burnt, expired, quality, dropped, leftovers, customer_return, other

FUNCTIONS:

core.fn_update_timestamp()
  -- Trigger function: Sets updated_at = now()

core.fn_audit_trigger()
  -- Trigger function: Checks audit_config, writes to platform.audit_log

core.fn_prevent_tenant_mutation()
  -- Trigger function: Raises exception if OLD.tenant_id != NEW.tenant_id

core.fn_to_tenant_time(ts timestamptz, p_tenant_id uuid, p_location_id uuid DEFAULT NULL)
  -- Returns timestamp in tenant/location timezone

core.fn_scale_ingredient(p_ingredient_id uuid, p_quantity numeric, p_from_unit_id int, p_to_unit_id int, p_scale_factor numeric)
  -- Returns TABLE (quantity numeric, unit_id int, warning text)

core.fn_validate_status_transition(p_category text, p_from_status text, p_to_status text, p_user_role text)
  -- Returns boolean, used in CHECK constraints or triggers

================================================================================
TENANT SCHEMA - BASE
================================================================================

tenant.locations
  tenant_id uuid NOT NULL REFERENCES platform.accounts(id)
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  name text NOT NULL
  address_line1 text
  address_line2 text
  city text
  state_province text
  postal_code text
  country_code char(2)
  timezone text  -- Overrides tenant default
  is_primary boolean NOT NULL DEFAULT false
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name) WHERE deleted_at IS NULL

tenant.settings
  tenant_id uuid NOT NULL REFERENCES platform.accounts(id)
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  setting_key text NOT NULL
  setting_value jsonb NOT NULL
  UNIQUE (tenant_id, setting_key)
  created_at, updated_at
  -- No deleted_at (settings are upserted, not deleted)

tenant.documents
  tenant_id uuid NOT NULL REFERENCES platform.accounts(id) ON DELETE CASCADE
  id uuid DEFAULT uuid_generate_v4() PK
  UNIQUE: (tenant_id, id)  -- For composite FK
  file_name text NOT NULL
  file_type text NOT NULL
  file_size integer
  storage_path text
  parsed_data jsonb
  parse_status text NOT NULL DEFAULT 'pending'  -- 'pending', 'processing', 'completed', 'failed'
  parse_error text
  parsed_at timestamptz
  event_id uuid  -- FK to tenant_events.events
  battle_board_id uuid  -- FK to tenant_events.battle_boards
  metadata jsonb DEFAULT '{}'::jsonb
  created_at, updated_at, deleted_at
  -- Purpose: PDF document storage and parsing tracking for Docling feature
  -- Stores uploaded PDFs, tracks parsing status, links to events/battle boards

================================================================================
TENANT.STAFF SCHEMA
================================================================================

tenant_staff.employees
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK references
  auth_user_id text UNIQUE  -- Links to auth.users, NULL if invite pending; accepts Clerk IDs
  employee_number text  -- Internal ID, UNIQUE per tenant
  email text NOT NULL
  first_name text NOT NULL
  last_name text NOT NULL
  phone text
  employment_type core.employment_type NOT NULL
  role text NOT NULL DEFAULT 'staff'  -- 'admin', 'manager', 'lead', 'staff'
  hourly_rate numeric(10,2)
  salary_annual numeric(12,2)
  hire_date date NOT NULL
  termination_date date
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, email) WHERE deleted_at IS NULL
  UNIQUE (tenant_id, employee_number) WHERE deleted_at IS NULL AND employee_number IS NOT NULL

tenant_staff.skills
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  name text NOT NULL
  category text
  description text
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name) WHERE deleted_at IS NULL

tenant_staff.employee_skills
  tenant_id uuid NOT NULL
  employee_id uuid NOT NULL
  skill_id uuid NOT NULL
  proficiency_level smallint NOT NULL DEFAULT 1 -- 1-5
  verified_by uuid -- employee_id
  verified_at timestamptz
  created_at, updated_at
  PK: (tenant_id, employee_id, skill_id)

tenant_staff.employee_locations (junction)
  tenant_id uuid NOT NULL
  employee_id uuid NOT NULL
  location_id uuid NOT NULL
  is_primary boolean NOT NULL DEFAULT false
  PK: (tenant_id, employee_id, location_id)
  -- FKs added in 090

tenant_staff.employee_certifications
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  employee_id uuid NOT NULL
  certification_type text NOT NULL  -- 'food_safety', 'alcohol', 'first_aid', etc.
  certification_name text NOT NULL
  issued_date date NOT NULL
  expiry_date date
  document_url text
  created_at, updated_at, deleted_at

tenant_staff.employee_availability
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  employee_id uuid NOT NULL
  day_of_week smallint NOT NULL  -- 0=Sunday, 6=Saturday
  start_time time NOT NULL
  end_time time NOT NULL
  is_available boolean NOT NULL DEFAULT true
  effective_from date NOT NULL
  effective_until date
  created_at, updated_at, deleted_at
  -- No overlapping availability for same employee+day

tenant_staff.schedules
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  location_id uuid  -- NULL = all locations
  schedule_date date NOT NULL
  status text NOT NULL DEFAULT 'draft'  -- draft, published, locked
  published_at timestamptz
  published_by uuid
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, location_id, schedule_date) WHERE deleted_at IS NULL

tenant_staff.schedule_shifts
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  schedule_id uuid NOT NULL
  employee_id uuid NOT NULL
  location_id uuid NOT NULL
  shift_start timestamptz NOT NULL
  shift_end timestamptz NOT NULL
  role_during_shift text  -- Override employee's default role
  notes text
  created_at, updated_at, deleted_at
  CHECK: shift_end > shift_start

tenant_staff.time_entries
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  employee_id uuid NOT NULL
  location_id uuid
  shift_id uuid  -- Links to scheduled shift if applicable
  clock_in timestamptz NOT NULL
  clock_out timestamptz
  break_minutes smallint NOT NULL DEFAULT 0
  notes text
  approved_by uuid
  approved_at timestamptz
  created_at, updated_at, deleted_at
  CHECK: clock_out IS NULL OR clock_out > clock_in

tenant_staff.payroll_periods
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  period_start date NOT NULL
  period_end date NOT NULL
  status text NOT NULL DEFAULT 'open'  -- open, processing, completed
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, period_start, period_end) WHERE deleted_at IS NULL
  CHECK: period_end > period_start

tenant_staff.payroll_runs
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  payroll_period_id uuid NOT NULL
  run_date timestamptz NOT NULL DEFAULT now()
  status text NOT NULL DEFAULT 'pending'  -- pending, approved, paid, void
  total_gross numeric(12,2) NOT NULL DEFAULT 0
  total_deductions numeric(12,2) NOT NULL DEFAULT 0
  total_net numeric(12,2) NOT NULL DEFAULT 0
  approved_by uuid
  approved_at timestamptz
  paid_at timestamptz
  created_at, updated_at, deleted_at

tenant_staff.payroll_line_items
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  payroll_run_id uuid NOT NULL
  employee_id uuid NOT NULL
  hours_regular numeric(6,2) NOT NULL DEFAULT 0
  hours_overtime numeric(6,2) NOT NULL DEFAULT 0
  rate_regular numeric(10,2) NOT NULL
  rate_overtime numeric(10,2) NOT NULL
  gross_pay numeric(10,2) NOT NULL
  deductions jsonb NOT NULL DEFAULT '{}'
  net_pay numeric(10,2) NOT NULL
  created_at, updated_at, deleted_at

tenant_staff.open_shifts
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  schedule_id uuid NOT NULL
  location_id uuid NOT NULL
  shift_start timestamptz NOT NULL
  shift_end timestamptz NOT NULL
  role_during_shift text
  notes text
  status text NOT NULL DEFAULT 'open'  -- 'open', 'claimed', 'filled', 'canceled'
  claimed_by uuid
  claimed_at timestamptz
  assigned_shift_id uuid  -- Links to schedule_shifts when filled
  created_at, updated_at, deleted_at
  CHECK: shift_end > shift_start
  -- Purpose: Track unassigned shifts that can be claimed or filled by employees
  -- Used for shift marketplace/claiming functionality

================================================================================
TENANT.CRM SCHEMA
================================================================================

tenant_crm.clients
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK references
  client_type text NOT NULL DEFAULT 'company'  -- company, individual
  company_name text
  first_name text
  last_name text
  email text
  phone text
  website text
  address_line1 text
  address_line2 text
  city text
  state_province text
  postal_code text
  country_code char(2)
  default_payment_terms smallint DEFAULT 30  -- days
  tax_exempt boolean NOT NULL DEFAULT false
  tax_id text
  notes text
  tags text[]
  source text  -- 'referral', 'website', 'cold_call', etc.
  assigned_to uuid  -- employee_id
  created_at, updated_at, deleted_at
  CHECK: (client_type = 'company' AND company_name IS NOT NULL) OR 
         (client_type = 'individual' AND first_name IS NOT NULL)

tenant_crm.client_contacts
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  client_id uuid NOT NULL
  first_name text NOT NULL
  last_name text NOT NULL
  title text
  email text
  phone text
  phone_mobile text
  is_primary boolean NOT NULL DEFAULT false
  is_billing_contact boolean NOT NULL DEFAULT false
  notes text
  created_at, updated_at, deleted_at

tenant_crm.client_preferences
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  client_id uuid NOT NULL
  preference_type text NOT NULL  -- 'dietary', 'service', 'communication', etc.
  preference_key text NOT NULL
  preference_value jsonb NOT NULL
  notes text
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, client_id, preference_type, preference_key) WHERE deleted_at IS NULL

tenant_crm.leads
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  source text  -- 'website', 'referral', 'event', etc.
  company_name text
  contact_name text NOT NULL
  contact_email text
  contact_phone text
  event_type text
  event_date date
  estimated_guests int
  estimated_value numeric(12,2)
  status text NOT NULL DEFAULT 'new'  -- References core.status_types category='lead'
  assigned_to uuid  -- employee_id
  notes text
  converted_to_client_id uuid  -- Set when lead converts
  converted_at timestamptz
  created_at, updated_at, deleted_at

tenant_crm.client_interactions
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  client_id uuid  -- NULL if lead interaction
  lead_id uuid    -- NULL if client interaction
  employee_id uuid NOT NULL
  interaction_type text NOT NULL  -- 'call', 'email', 'meeting', 'note'
  interaction_date timestamptz NOT NULL DEFAULT now()
  subject text
  description text
  follow_up_date date
  follow_up_completed boolean NOT NULL DEFAULT false
  created_at, updated_at, deleted_at
  CHECK: (client_id IS NOT NULL) OR (lead_id IS NOT NULL)

tenant_crm.proposals
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  proposal_number text NOT NULL  -- Auto-generated per tenant
  client_id uuid  -- NULL if from lead
  lead_id uuid    -- NULL if from client
  event_id uuid   -- Links to events.events if created
  title text NOT NULL
  event_date date
  event_type text
  guest_count int
  venue_name text
  venue_address text
  subtotal numeric(12,2) NOT NULL DEFAULT 0
  tax_rate numeric(5,4) NOT NULL DEFAULT 0
  tax_amount numeric(12,2) NOT NULL DEFAULT 0
  discount_amount numeric(12,2) NOT NULL DEFAULT 0
  total numeric(12,2) NOT NULL DEFAULT 0
  status text NOT NULL DEFAULT 'draft'  -- References core.status_types category='proposal'
  valid_until date
  sent_at timestamptz
  viewed_at timestamptz
  accepted_at timestamptz
  rejected_at timestamptz
  notes text
  terms_and_conditions text
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, proposal_number) WHERE deleted_at IS NULL

tenant_crm.proposal_line_items
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  proposal_id uuid NOT NULL
  sort_order smallint NOT NULL DEFAULT 0
  item_type text NOT NULL  -- 'dish', 'service', 'rental', 'labor', 'other'
  description text NOT NULL
  quantity numeric(10,2) NOT NULL DEFAULT 1
  unit_price numeric(12,2) NOT NULL
  total numeric(12,2) NOT NULL
  notes text
  created_at, updated_at, deleted_at

================================================================================
TENANT.KITCHEN SCHEMA
================================================================================

tenant_kitchen.ingredients
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  name text NOT NULL
  category text  -- 'produce', 'protein', 'dairy', 'dry_goods', etc.
  default_unit_id smallint NOT NULL REFERENCES core.units
  density_g_per_ml numeric(10,4)  -- For volume<->weight conversion
  shelf_life_days smallint
  storage_instructions text
  allergens text[]  -- 'gluten', 'dairy', 'nuts', 'shellfish', etc.
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name) WHERE deleted_at IS NULL

tenant_kitchen.containers
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  location_id uuid  -- NULL = all locations
  name text NOT NULL
  container_type text NOT NULL  -- 'hotel_pan', 'cambro', 'sheet_tray', etc.
  size_description text  -- 'Full', 'Half', '1/3', etc.
  capacity_volume_ml numeric(10,2)
  capacity_weight_g numeric(10,2)
  capacity_portions int
  is_reusable boolean NOT NULL DEFAULT true
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name, size_description) WHERE deleted_at IS NULL

tenant_kitchen.prep_methods
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  name text NOT NULL
  category text  -- 'storage', 'prep', 'cooking', 'plating', etc.
  description text
  estimated_duration_minutes int
  requires_certification text[]  -- Which certifications needed
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name) WHERE deleted_at IS NULL

tenant_kitchen.method_videos
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  method_id uuid NOT NULL
  title text NOT NULL
  video_url text NOT NULL
  thumbnail_url text
  duration_seconds int
  sort_order smallint NOT NULL DEFAULT 0
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at

tenant_kitchen.recipes
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  name text NOT NULL
  category text  -- 'appetizer', 'entree', 'dessert', 'beverage', etc.
  cuisine_type text
  description text
  tags text[]
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name) WHERE deleted_at IS NULL

tenant_kitchen.recipe_versions
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK (tasks reference this)
  recipe_id uuid NOT NULL
  version_number int NOT NULL  -- Auto-increment per recipe
  yield_quantity numeric(10,2) NOT NULL
  yield_unit_id smallint NOT NULL REFERENCES core.units
  yield_description text  -- "12 portions", "2 hotel pans", etc.
  prep_time_minutes int
  cook_time_minutes int
  rest_time_minutes int
  difficulty_level smallint  -- 1-5
  notes text
  is_locked boolean NOT NULL DEFAULT false
  locked_at timestamptz
  locked_by uuid
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, recipe_id, version_number)
  -- Trigger: Cannot UPDATE if is_locked = true (except to lock it)

tenant_kitchen.recipe_ingredients
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  recipe_version_id uuid NOT NULL
  ingredient_id uuid NOT NULL
  quantity numeric(10,4) NOT NULL
  unit_id smallint NOT NULL REFERENCES core.units
  preparation_notes text  -- "diced", "room temperature", etc.
  is_optional boolean NOT NULL DEFAULT false
  sort_order smallint NOT NULL DEFAULT 0
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, recipe_version_id, ingredient_id) WHERE deleted_at IS NULL

tenant_kitchen.recipe_steps
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  recipe_version_id uuid NOT NULL
  step_number smallint NOT NULL
  instruction text NOT NULL
  duration_minutes int
  temperature_value numeric(5,1)
  temperature_unit char(1)  -- 'F' or 'C'
  equipment_needed text[]
  tips text
  video_url text
  image_url text
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, recipe_version_id, step_number)

tenant_kitchen.dishes
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  recipe_id uuid NOT NULL  -- Current/default recipe
  name text NOT NULL
  description text
  category text  -- Menu category
  service_style text  -- 'plated', 'buffet', 'family_style', 'passed'
  default_container_id uuid
  presentation_image_url text
  min_prep_lead_days smallint NOT NULL DEFAULT 0  -- Earliest prep day before event
  max_prep_lead_days smallint  -- Latest prep day (NULL = day of)
  portion_size_description text
  dietary_tags text[]  -- 'vegetarian', 'vegan', 'gluten_free', etc.
  allergens text[]
  price_per_person numeric(10,2)
  cost_per_person numeric(10,2)
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name) WHERE deleted_at IS NULL

tenant_kitchen.prep_tasks
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  event_id uuid NOT NULL
  dish_id uuid  -- NULL for non-dish prep (e.g., setup tasks)
  recipe_version_id uuid  -- Locked version; NULL for non-recipe tasks
  method_id uuid
  container_id uuid
  location_id uuid NOT NULL
  task_type text NOT NULL DEFAULT 'prep'  -- 'prep', 'cook', 'plate', 'pack', 'setup'
  name text NOT NULL  -- Task description if no dish
  quantity_total numeric(10,2) NOT NULL
  quantity_unit_id smallint REFERENCES core.units
  quantity_completed numeric(10,2) NOT NULL DEFAULT 0
  servings_total int  -- If recipe-based, calculated from quantity
  start_by_date date NOT NULL  -- Interpret in tenant timezone
  due_by_date date NOT NULL
  due_by_time time  -- NULL = end of day
  is_event_finish boolean NOT NULL DEFAULT false  -- Finished at venue vs kitchen
  status text NOT NULL DEFAULT 'pending'  -- References core.status_types category='task'
  priority smallint NOT NULL DEFAULT 5  -- 1=highest, 10=lowest
  estimated_minutes int
  actual_minutes int
  do_not_complete_until timestamptz
  import_id uuid
  notes text
  created_at, updated_at, deleted_at
  CHECK: quantity_completed <= quantity_total
  CHECK: due_by_date >= start_by_date

tenant_kitchen.kitchen_tasks
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  title text NOT NULL
  summary text NOT NULL
  status text NOT NULL DEFAULT 'pending'  -- 'pending', 'in_progress', 'completed', 'cancelled', 'deferred'
  priority smallint NOT NULL DEFAULT 5  -- 1=highest, 10=lowest
  complexity smallint NOT NULL DEFAULT 5  -- 1-10 scale
  tags text[]
  due_date timestamptz
  completed_at timestamptz
  created_at, updated_at, deleted_at
  CHECK: length(trim(title)) >= 3 AND length(trim(title)) <= 200
  CHECK: length(trim(summary)) >= 10 AND length(trim(summary)) <= 5000
  CHECK: priority >= 1 AND priority <= 10
  CHECK: complexity >= 1 AND complexity <= 10
  CHECK: status = 'completed' OR completed_at IS NULL
  NOTE: Simple CRUD tasks for general task tracking, separate from event-driven prep_tasks

tenant_kitchen.task_bundles
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  event_id uuid  -- NULL for template bundles
  name text NOT NULL
  description text
  is_template boolean NOT NULL DEFAULT false
  created_at, updated_at, deleted_at

tenant_kitchen.task_bundle_items
  tenant_id uuid NOT NULL
  bundle_id uuid NOT NULL
  task_id uuid NOT NULL
  sort_order smallint NOT NULL DEFAULT 0
  PK: (tenant_id, bundle_id, task_id)
  created_at

tenant_kitchen.task_claims
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  task_id uuid NOT NULL
  employee_id uuid NOT NULL
  claimed_at timestamptz NOT NULL DEFAULT now()
  released_at timestamptz
  release_reason text  -- 'completed', 'reassigned', 'shift_ended', 'abandoned'
  created_at, updated_at
  -- No deleted_at (claims are historical record)
  UNIQUE INDEX: (tenant_id, task_id) WHERE released_at IS NULL  -- One active claim

tenant_kitchen.task_progress
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  task_id uuid NOT NULL
  employee_id uuid NOT NULL
  progress_type text NOT NULL  -- 'status_change', 'quantity_update', 'note', 'issue'
  old_status text
  new_status text
  quantity_completed numeric(10,2)
  notes text
  created_at timestamptz NOT NULL DEFAULT now()
  -- No updated_at/deleted_at (immutable log)

tenant_kitchen.prep_comments
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  task_id uuid NOT NULL
  employee_id uuid NOT NULL
  comment_text text NOT NULL
  is_resolved boolean NOT NULL DEFAULT false
  resolved_at timestamptz
  resolved_by uuid
  created_at, updated_at, deleted_at
  FK: (tenant_id, task_id) -> tenant_kitchen.prep_tasks

tenant_kitchen.prep_list_imports
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  source_system text NOT NULL
  external_id text
  import_metadata jsonb
  imported_by uuid NOT NULL -- employee_id
  created_at timestamptz NOT NULL

tenant_kitchen.bulk_combine_rules
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  name text NOT NULL
  match_criteria jsonb NOT NULL
  is_automatic boolean NOT NULL DEFAULT false
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at

tenant_kitchen.waste_entries
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  inventory_item_id uuid NOT NULL  -- What was wasted
  reason_id smallint NOT NULL  -- FK to core.waste_reasons
  quantity numeric(10,3) NOT NULL  -- Amount wasted
  unit_id smallint  -- Unit of measure (FK to core.units)
  location_id uuid  -- Where waste occurred
  event_id uuid  -- If during an event
  logged_by uuid NOT NULL  -- Employee who logged
  logged_at timestamptz NOT NULL DEFAULT now()
  unit_cost numeric(10,2)  -- Cost per unit at time of entry
  total_cost numeric(10,2)  -- Calculated total cost
  notes text  -- Additional context
  created_at, updated_at, deleted_at
  CHECK: quantity > 0
  FK: (tenant_id, inventory_item_id) -> tenant_inventory.inventory_items
  FK: (tenant_id, location_id) -> tenant.locations
  FK: (tenant_id, event_id) -> tenant_events.events
  FK: (tenant_id, logged_by) -> tenant_staff.employees
  FK: (reason_id) -> core.waste_reasons
  FK: (unit_id) -> core.units

================================================================================
TENANT.EVENTS SCHEMA
================================================================================

tenant_events.events
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  event_number text NOT NULL  -- Auto-generated per tenant (e.g., "EVT-2024-0001")
  client_id uuid NOT NULL
  proposal_id uuid  -- Link to accepted proposal
  location_id uuid  -- Which kitchen handles this
  event_type text NOT NULL  -- 'wedding', 'corporate', 'social', etc.
  event_name text NOT NULL
  event_date date NOT NULL
  event_start_time time
  event_end_time time
  event_timezone text  -- Override tenant/location timezone
  setup_start_time time
  guest_count int NOT NULL
  venue_name text
  venue_address_line1 text
  venue_address_line2 text
  venue_city text
  venue_state_province text
  venue_postal_code text
  venue_contact_name text
  venue_contact_phone text
  venue_notes text
  dietary_restrictions jsonb  -- {"vegetarian": 5, "vegan": 2, "gluten_free": 3}
  status text NOT NULL DEFAULT 'confirmed'  -- References core.status_types category='event'
  do_not_complete_until timestamptz
  total_revenue numeric(12,2) NOT NULL DEFAULT 0
  total_cost numeric(12,2) NOT NULL DEFAULT 0
  notes text
  internal_notes text  -- Staff-only notes
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, event_number) WHERE deleted_at IS NULL

tenant_events.event_dishes
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  event_id uuid NOT NULL
  dish_id uuid NOT NULL
  course text  -- 'appetizer', 'main', 'dessert', etc.
  quantity_servings int NOT NULL
  service_style text  -- Override dish default
  special_instructions text
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, event_id, dish_id) WHERE deleted_at IS NULL

tenant_events.event_staff_assignments
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  event_id uuid NOT NULL
  employee_id uuid NOT NULL
  role text NOT NULL  -- 'chef', 'server', 'bartender', 'coordinator', etc.
  start_time timestamptz
  end_time timestamptz
  notes text
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, event_id, employee_id) WHERE deleted_at IS NULL

tenant_events.event_timeline
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  event_id uuid NOT NULL
  timeline_time time NOT NULL
  description text NOT NULL
  responsible_role text
  is_completed boolean NOT NULL DEFAULT false
  completed_at timestamptz
  notes text
  sort_order smallint NOT NULL DEFAULT 0
  created_at, updated_at, deleted_at

tenant_events.timeline_tasks
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  event_id uuid NOT NULL
  title text NOT NULL
  description text
  start_time timestamptz NOT NULL
  end_time timestamptz NOT NULL
  status text NOT NULL DEFAULT 'not_started'  -- 'not_started', 'in_progress', 'completed', 'delayed', 'blocked'
  priority text NOT NULL DEFAULT 'medium'  -- 'low', 'medium', 'high', 'critical'
  category text NOT NULL
  assignee_id uuid  -- FK to tenant_staff.employees
  progress integer NOT NULL DEFAULT 0  -- 0-100
  dependencies text[] NOT NULL DEFAULT '{}'  -- Array of task IDs
  is_on_critical_path boolean NOT NULL DEFAULT false
  slack_minutes integer NOT NULL DEFAULT 0
  notes text
  created_at, updated_at, deleted_at
  -- Purpose: Event-specific tactical planning tasks with minute-by-minute precision
  -- Supports dependencies, critical path analysis, and staff coordination

tenant_events.battle_boards
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  event_id uuid  -- Nullable FK to events (NULL for generic/template boards)
  board_name text NOT NULL
  board_type text NOT NULL DEFAULT 'event-specific'  -- 'generic', 'event-specific', 'template'
  schema_version text NOT NULL DEFAULT 'mangia-battle-board@1'
  board_data jsonb NOT NULL DEFAULT '{}'  -- JSONB battle board structure
  document_url text  -- Cloud storage URL (S3, Supabase Storage)
  source_document_type text  -- 'pdf', 'csv', 'excel', 'goodshuffle', 'nowsta', 'manual'
  document_imported_at timestamptz
  status text NOT NULL DEFAULT 'draft'  -- 'draft', 'active', 'archived', 'template'
  is_template boolean NOT NULL DEFAULT false
  description text
  notes text
  tags text[]
  created_at, updated_at, deleted_at

tenant_events.battle_board_uploads
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  file_path text NOT NULL  -- Storage path
  file_size bigint NOT NULL
  file_type text NOT NULL
  original_filename text NOT NULL
  upload_status text NOT NULL DEFAULT 'pending'  -- 'pending', 'processing', 'completed', 'failed', 'expired'
  battle_board_id uuid  -- FK to battle_boards (NULL until linked)
  uploaded_at timestamptz NOT NULL DEFAULT now()
  processed_at timestamptz
  expires_at timestamptz NOT NULL DEFAULT now() + interval '90 days'  -- 90-day retention
  created_at, updated_at, deleted_at
  -- Purpose: Track file uploads for battle boards with 90-day retention policy

tenant_events.catering_orders
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (id)  -- Global unique for order_number lookup
  customer_id uuid NOT NULL  -- FK to tenant_crm.clients
  event_id uuid  -- FK to tenant_events.events (nullable for advance orders)
  order_number text NOT NULL UNIQUE  -- Format: ORD-YYYY-NNNN
  order_status text NOT NULL DEFAULT 'draft'  -- 'draft', 'pending_review', 'confirmed', 'in_progress', 'ready', 'delivered', 'completed', 'cancelled', 'on_hold'
  order_date timestamptz NOT NULL DEFAULT now()
  delivery_date timestamptz NOT NULL
  delivery_time text NOT NULL  -- Format: "HH:MM AM/PM"
  subtotal_amount numeric(12,2) NOT NULL DEFAULT 0
  tax_amount numeric(12,2) NOT NULL DEFAULT 0
  discount_amount numeric(12,2) NOT NULL DEFAULT 0
  service_charge_amount numeric(12,2) NOT NULL DEFAULT 0
  total_amount numeric(12,2) NOT NULL DEFAULT 0
  deposit_required boolean NOT NULL DEFAULT false
  deposit_amount numeric(12,2)
  deposit_paid boolean NOT NULL DEFAULT false
  deposit_paid_at timestamptz
  venue_name text
  venue_address text
  venue_city text
  venue_state text
  venue_zip text
  venue_contact_name text
  venue_contact_phone text
  guest_count integer NOT NULL DEFAULT 0
  special_instructions text
  dietary_restrictions text
  staff_required integer DEFAULT 0
  staff_assigned integer DEFAULT 0
  created_at, updated_at, deleted_at
  -- Purpose: Order management for catering operations, separate from events
  -- Includes status transition validation and auto-generated order numbers

tenant_events.event_imports
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  event_id uuid NOT NULL
  file_name text NOT NULL
  mime_type text NOT NULL
  file_size integer NOT NULL DEFAULT 0
  content bytea NOT NULL  -- Raw file content stored in database
  created_at timestamptz NOT NULL DEFAULT now()
  -- Purpose: Store source documents (CSV/PDF) per event for import processing
  -- Note: No deleted_at (immutable import records)

================================================================================
TENANT.INVENTORY SCHEMA
================================================================================

tenant_inventory.inventory_suppliers
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, supplier_number)  -- Auto-generated supplier number
  supplier_number text NOT NULL  -- Auto-generated per tenant
  name text NOT NULL
  contact_person text
  email text
  phone text
  payment_terms text NOT NULL DEFAULT 'NET_30'
  notes text
  tags text[] DEFAULT '{}'
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, supplier_number) WHERE deleted_at IS NULL
  -- Note: Named inventory_suppliers in migrations (not vendors)
  -- Purpose: Master supplier catalog with auto-generated supplier numbers

tenant_inventory.inventory_items
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  ingredient_id uuid  -- Link to kitchen ingredient if applicable
  name text NOT NULL
  sku text
  category text NOT NULL
  default_unit_id smallint NOT NULL REFERENCES core.units
  par_level numeric(10,2)  -- Minimum stock level
  reorder_point numeric(10,2)
  reorder_quantity numeric(10,2)
  cost_per_unit numeric(10,4)
  preferred_vendor_id uuid
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name) WHERE deleted_at IS NULL
  UNIQUE (tenant_id, sku) WHERE deleted_at IS NULL AND sku IS NOT NULL

tenant_inventory.storage_locations
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  UNIQUE: (tenant_id, id)  -- For composite FK
  location_id uuid NOT NULL  -- Physical site
  name text NOT NULL  -- "Walk-in Cooler", "Dry Storage Room A"
  storage_type text NOT NULL  -- 'refrigerated', 'frozen', 'dry', 'ambient'
  temperature_min numeric(5,1)
  temperature_max numeric(5,1)
  temperature_unit char(1) DEFAULT 'F'
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, location_id, name) WHERE deleted_at IS NULL

tenant_inventory.inventory_stock
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  item_id uuid NOT NULL
  storage_location_id uuid NOT NULL
  quantity_on_hand numeric(10,2) NOT NULL DEFAULT 0
  unit_id smallint NOT NULL REFERENCES core.units
  last_counted_at timestamptz
  last_counted_by uuid
  created_at, updated_at
  UNIQUE (tenant_id, item_id, storage_location_id)

tenant_inventory.inventory_transactions
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  item_id uuid NOT NULL
  storage_location_id uuid
  transaction_type text NOT NULL  -- 'receive', 'use', 'waste', 'transfer', 'adjust', 'count'
  quantity numeric(10,2) NOT NULL  -- Positive or negative
  unit_id smallint NOT NULL REFERENCES core.units
  unit_cost numeric(10,4)
  reference_type text  -- 'purchase_order', 'event', 'prep_task', 'manual'
  reference_id uuid
  from_location_id uuid  -- For transfers
  to_location_id uuid    -- For transfers
  notes text
  performed_by uuid NOT NULL
  created_at timestamptz NOT NULL DEFAULT now()
  -- No updated_at/deleted_at (immutable ledger)

tenant_inventory.inventory_alerts
   tenant_id uuid NOT NULL
   id uuid DEFAULT gen_random_uuid()
   PK: (tenant_id, id)
   item_id uuid NOT NULL
   alert_type text NOT NULL  -- 'LOW_STOCK', 'EXPIRED', 'REORDER'
   threshold_value numeric(12,3) NOT NULL
   triggered_at timestamptz NOT NULL DEFAULT now()
   resolved_at timestamptz NULL
   notes text
   created_at, updated_at, deleted_at
   -- Purpose: System alerts for inventory thresholds and issues
   -- Tracks low stock warnings, expiration alerts, reorder notifications

tenant_inventory.inventory_forecasts
   tenant_id uuid NOT NULL
   id uuid DEFAULT gen_random_uuid()
   PK: (tenant_id, id)
   sku text NOT NULL
   date date NOT NULL
   forecast numeric(10,2) NOT NULL
   lower_bound numeric(10,2) NOT NULL
   upper_bound numeric(10,2) NOT NULL
   confidence numeric(3,2) NOT NULL
   horizon_days int NOT NULL
   last_updated timestamptz NOT NULL DEFAULT now()
   created_at, updated_at, deleted_at
   UNIQUE (tenant_id, sku, date)
   -- Purpose: Time-series forecast data with confidence intervals
   -- Supports AI-powered inventory depletion forecasting

tenant_inventory.forecast_inputs
   tenant_id uuid NOT NULL
   id uuid DEFAULT gen_random_uuid()
   PK: (tenant_id, id)
   sku text NOT NULL
   date date NOT NULL
   historical_usage numeric(10,2) NOT NULL
   events jsonb
   promotions jsonb
   seasonality_factors jsonb
   created_at, updated_at, deleted_at
   UNIQUE (tenant_id, sku, date)
   -- Purpose: Input data for forecasting models
   -- Includes historical data, events, promotions for accurate predictions

tenant_inventory.reorder_suggestions
   tenant_id uuid NOT NULL
   id uuid DEFAULT gen_random_uuid()
   PK: (tenant_id, id)
   sku text NOT NULL
   recommended_order_qty numeric(10,2) NOT NULL
   reorder_point numeric(10,2) NOT NULL
   safety_stock numeric(10,2) NOT NULL
   lead_time_days int NOT NULL
   justification text NOT NULL
   created_at, updated_at, deleted_at
   -- Purpose: Automated reorder recommendations with justification
   -- Includes safety stock calculations and lead time considerations

tenant_inventory.alerts_config
   tenant_id uuid NOT NULL
   id uuid DEFAULT gen_random_uuid()
   PK: (tenant_id, id)
   channel text NOT NULL  -- 'email', 'slack', 'webhook'
   destination text NOT NULL
   created_at, updated_at, deleted_at
   -- Purpose: Alert delivery configuration for inventory notifications
   -- Supports multiple channels (email, Slack, webhook)


tenant_inventory.purchase_orders
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  po_number text NOT NULL  -- Auto-generated
  vendor_id uuid NOT NULL  -- FK to inventory_suppliers (not vendors)
  location_id uuid NOT NULL  -- Delivery location
  order_date date NOT NULL DEFAULT CURRENT_DATE
  expected_delivery_date date
  actual_delivery_date date
  status text NOT NULL DEFAULT 'draft'  -- draft, submitted, confirmed, received, cancelled
  subtotal numeric(12,2) NOT NULL DEFAULT 0
  tax_amount numeric(12,2) NOT NULL DEFAULT 0
  shipping_amount numeric(12,2) NOT NULL DEFAULT 0
  total numeric(12,2) NOT NULL DEFAULT 0
  notes text
  submitted_by uuid
  submitted_at timestamptz
  received_by uuid
  received_at timestamptz
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, po_number) WHERE deleted_at IS NULL

tenant_inventory.purchase_order_items
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  purchase_order_id uuid NOT NULL
  item_id uuid NOT NULL
  quantity_ordered numeric(10,2) NOT NULL
  quantity_received numeric(10,2) NOT NULL DEFAULT 0
  unit_id smallint NOT NULL REFERENCES core.units
  unit_cost numeric(10,4) NOT NULL
  total_cost numeric(12,2) NOT NULL
  notes text
  created_at, updated_at, deleted_at

tenant_inventory.inventory_counts
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  location_id uuid NOT NULL
  storage_location_id uuid  -- NULL = full location count
  count_date date NOT NULL
  status text NOT NULL DEFAULT 'in_progress'  -- in_progress, completed, cancelled
  started_by uuid NOT NULL
  started_at timestamptz NOT NULL DEFAULT now()
  completed_by uuid
  completed_at timestamptz
  notes text
  created_at, updated_at, deleted_at

tenant_inventory.inventory_count_items
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  count_id uuid NOT NULL
  item_id uuid NOT NULL
  storage_location_id uuid NOT NULL
  expected_quantity numeric(10,2)
  counted_quantity numeric(10,2) NOT NULL
  unit_id smallint NOT NULL REFERENCES core.units
  variance numeric(10,2)  -- counted - expected
  notes text
  counted_by uuid NOT NULL
  counted_at timestamptz NOT NULL DEFAULT now()
  created_at

================================================================================
TENANT.ADMIN SCHEMA
================================================================================

tenant_admin.workflows
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  name text NOT NULL
  description text
  trigger_type text NOT NULL  -- 'manual', 'schedule', 'event', 'threshold'
  trigger_config jsonb NOT NULL DEFAULT '{}'
  is_active boolean NOT NULL DEFAULT true
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name) WHERE deleted_at IS NULL

tenant_admin.workflow_steps
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  workflow_id uuid NOT NULL
  step_number smallint NOT NULL
  step_type text NOT NULL  -- 'action', 'condition', 'delay', 'notification'
  step_config jsonb NOT NULL
  on_success_step_id uuid  -- NULL = next step or end
  on_failure_step_id uuid  -- NULL = abort
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, workflow_id, step_number)

tenant_admin.workflow_executions
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  workflow_id uuid NOT NULL
  triggered_by uuid  -- employee_id or NULL for automatic
  trigger_data jsonb
  status text NOT NULL DEFAULT 'running'  -- running, completed, failed, cancelled
  current_step_id uuid
  started_at timestamptz NOT NULL DEFAULT now()
  completed_at timestamptz
  error_message text
  execution_log jsonb NOT NULL DEFAULT '[]'
  created_at

tenant_admin.reports
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  name text NOT NULL
  description text
  report_type text NOT NULL  -- 'financial', 'operational', 'inventory', 'staff', 'custom'
  query_config jsonb NOT NULL  -- Defines what data to pull
  display_config jsonb NOT NULL DEFAULT '{}'  -- Charts, columns, etc.
  is_system boolean NOT NULL DEFAULT false  -- Built-in vs custom
  created_by uuid
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, name) WHERE deleted_at IS NULL

tenant_admin.report_schedules
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  report_id uuid NOT NULL
  schedule_cron text NOT NULL  -- Cron expression
  output_format text NOT NULL DEFAULT 'pdf'  -- pdf, xlsx, csv
  recipients jsonb NOT NULL  -- Array of employee_ids or emails
  is_active boolean NOT NULL DEFAULT true
  last_run_at timestamptz
  next_run_at timestamptz
  created_at, updated_at, deleted_at

tenant_admin.report_history
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  report_id uuid NOT NULL
  schedule_id uuid  -- NULL if manual run
  generated_by uuid  -- NULL if scheduled
  generated_at timestamptz NOT NULL DEFAULT now()
  output_format text NOT NULL
  file_url text  -- Stored report file
  file_size_bytes int
  parameters jsonb  -- Runtime parameters used
  created_at

tenant_admin.notifications
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  recipient_employee_id uuid NOT NULL
  notification_type text NOT NULL  -- 'task_assigned', 'event_reminder', 'inventory_low', etc.
  title text NOT NULL
  body text
  action_url text  -- Deep link
  is_read boolean NOT NULL DEFAULT false
  read_at timestamptz
  created_at
  -- No updated_at/deleted_at (immutable, auto-expire via retention policy)

tenant_admin.notification_preferences
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  employee_id uuid NOT NULL
  notification_type text NOT NULL
  channel text NOT NULL  -- 'in_app', 'email', 'sms', 'push'
  is_enabled boolean NOT NULL DEFAULT true
  created_at, updated_at
  UNIQUE (tenant_id, employee_id, notification_type, channel)

tenant_admin.admin_roles
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  role_name tenant_admin.admin_role NOT NULL  -- Enum: 'super_admin', 'tenant_admin', 'finance_manager', 'operations_manager', 'staff_manager', 'read_only'
  description text
  permissions jsonb DEFAULT '[]'::jsonb
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, role_name) WHERE deleted_at IS NULL
  -- Purpose: RBAC role definitions for admin users

tenant_admin.admin_permissions
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  permission_name text NOT NULL
  resource_type text NOT NULL  -- 'table', 'function', 'module', etc.
  resource_name text NOT NULL
  action text NOT NULL  -- 'read', 'write', 'delete', 'execute', etc.
  description text
  created_at, updated_at, deleted_at
  UNIQUE (tenant_id, permission_name) WHERE deleted_at IS NULL
  -- Purpose: Permission definitions for RBAC system

tenant_admin.admin_users
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  auth_user_id uuid NOT NULL  -- Links to auth.users
  role_id uuid NOT NULL  -- FK to admin_roles
  is_active boolean NOT NULL DEFAULT true
  last_login timestamptz
  last_failed_login timestamptz
  failed_login_attempts smallint DEFAULT 0
  locked_until timestamptz
  two_factor_enabled boolean NOT NULL DEFAULT false
  two_factor_secret text
  login_ip text
  created_at, updated_at, deleted_at
  -- Purpose: Admin user accounts with RBAC, 2FA, and security features

tenant_admin.admin_audit_trail
  tenant_id uuid NOT NULL
  id uuid DEFAULT gen_random_uuid()
  PK: (tenant_id, id)
  admin_user_id uuid NOT NULL  -- FK to admin_users
  entity_type tenant_admin.admin_entity_type NOT NULL  -- Enum: 'admin_users', 'admin_roles', 'admin_permissions', 'users', 'roles', 'permissions', 'tenants', 'reports', 'settings'
  entity_id uuid
  action tenant_admin.admin_action NOT NULL  -- Enum: 'login', 'logout', 'create', 'update', 'delete', 'view', 'permission_change', 'role_change', 'account_change', 'security_change'
  description text
  changes jsonb
  old_values jsonb
  new_values jsonb
  ip_address inet
  user_agent text
  created_at, deleted_at
  -- Purpose: Audit trail for admin operations and security events
  -- Note: No updated_at (immutable audit log)

================================================================================
CROSS-MODULE FK SUMMARY (for 090_cross_module_fks.sql)
================================================================================

-- staff.employees -> platform.accounts
-- staff.employee_locations -> staff.employees, tenant.locations
-- staff.schedule_shifts -> staff.schedules, staff.employees, tenant.locations
-- staff.time_entries -> staff.employees, tenant.locations, staff.schedule_shifts
-- staff.payroll_runs -> staff.payroll_periods
-- staff.payroll_line_items -> staff.payroll_runs, staff.employees

-- crm.client_contacts -> crm.clients
-- crm.client_preferences -> crm.clients
-- crm.leads.assigned_to -> staff.employees
-- crm.leads.converted_to_client_id -> crm.clients
-- crm.client_interactions -> crm.clients, crm.leads, staff.employees
-- crm.proposals -> crm.clients, crm.leads, events.events

-- kitchen.recipe_versions -> kitchen.recipes
-- kitchen.recipe_ingredients -> kitchen.recipe_versions, kitchen.ingredients
-- kitchen.recipe_steps -> kitchen.recipe_versions
-- kitchen.method_videos -> kitchen.prep_methods
-- kitchen.dishes -> kitchen.recipes, kitchen.containers
-- kitchen.prep_tasks -> events.events, kitchen.dishes, kitchen.recipe_versions, kitchen.prep_methods, kitchen.containers, tenant.locations
-- kitchen.task_bundle_items -> kitchen.task_bundles, kitchen.prep_tasks
-- kitchen.task_claims -> kitchen.prep_tasks, staff.employees
-- kitchen.task_progress -> kitchen.prep_tasks, staff.employees

-- events.events -> crm.clients, crm.proposals, tenant.locations
-- events.event_dishes -> events.events, kitchen.dishes
-- events.event_staff_assignments -> events.events, staff.employees
-- events.event_timeline -> events.events

-- inventory.inventory_items -> kitchen.ingredients, inventory.inventory_suppliers
-- inventory.storage_locations -> tenant.locations
-- inventory.inventory_stock -> inventory.inventory_items, inventory.storage_locations
-- inventory.inventory_transactions -> inventory.inventory_items, inventory.storage_locations, staff.employees
-- inventory.purchase_orders -> inventory.inventory_suppliers, tenant.locations
-- inventory.purchase_order_items -> inventory.purchase_orders, inventory.inventory_items
-- inventory.inventory_counts -> tenant.locations, inventory.storage_locations
-- inventory.inventory_count_items -> inventory.inventory_counts, inventory.inventory_items, inventory.storage_locations

-- admin.workflow_steps -> admin.workflows
-- admin.workflow_executions -> admin.workflows
-- admin.reports.created_by -> staff.employees
-- admin.report_schedules -> admin.reports
-- admin.report_history -> admin.reports, admin.report_schedules
-- admin.notifications -> staff.employees
-- admin.notification_preferences -> staff.employees

================================================================================
REALTIME TABLES (need REPLICA IDENTITY FULL)
================================================================================

tenant_kitchen.task_claims
tenant_kitchen.task_progress
tenant_kitchen.prep_tasks (status changes)
tenant_events.events (status changes)
tenant_admin.notifications
