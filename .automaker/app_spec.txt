<?xml version="1.0" encoding="UTF-8"?>
<project_specification>
  <project_name>Convoy - Mobile Task Management for Kitchen Staff</project_name>

  <overview>
    Convoy is an enterprise catering business suite built as a monorepo using Next.js, React, and TypeScript. The Mobile Task Management feature (branch 003-mobile-task-management) focuses on creating a mobile-first application for kitchen staff to manage and complete food production tasks during daily operations and events.

The primary purpose is to enable line cooks, prep cooks, and kitchen staff to view, claim, complete, and manage kitchen tasks with minimal cognitive overhead and fast interaction patterns optimized for mobile devices in fast-paced kitchen environments.

Key goals include:
- Real-time task synchronization across all team members (within 2 seconds)
- Single-tap task claiming and completion workflows
- Role-based access control (staff see assigned/available tasks, managers see all)
- Multi-tenant isolation with tenant-scoped data access via Clerk organizations
- Recipe and method reference access during task execution
- Automatic time tracking (starts on claim, stops on completion)
- Bulk combining of tasks across events with intelligent detection and manual override
- Prep list imports from multiple document formats (CSV, PDF, images, markdown)
- Staff proficiency tracking with leveling system based on completions, complexity, certifications, and seniority
  </overview>

  <technology_stack>
    <technology>Next.js 16 (App Router)</technology>
    <technology>React 19</technology>
    <technology>TypeScript 5.9</technology>
    <technology>Turbo (monorepo tooling)</technology>
    <technology>pnpm (package manager)</technology>
    <technology>Prisma 7 with Neon adapter (ORM)</technology>
    <technology>Neon (serverless PostgreSQL)</technology>
    <technology>Clerk (authentication and organization management)</technology>
    <technology>Ably (real-time pub/sub for task updates)</technology>
    <technology>Tailwind CSS 4.x</technology>
    <technology>Radix UI (component primitives)</technology>
    <technology>shadcn/ui (design system components)</technology>
    <technology>Zod (schema validation)</technology>
    <technology>Vercel AI SDK with OpenAI (AI features)</technology>
    <technology>Sentry (error monitoring)</technology>
    <technology>Logtail (logging)</technology>
    <technology>PostHog (product analytics)</technology>
    <technology>Vercel Analytics (web analytics)</technology>
    <technology>Stripe (payments)</technology>
    <technology>Knock (notifications)</technology>
    <technology>Liveblocks (collaboration)</technology>
    <technology>Vercel Blob (file storage)</technology>
    <technology>Upstash Redis (rate limiting)</technology>
    <technology>Svix (webhooks)</technology>
    <technology>React Hook Form (form handling)</technology>
    <technology>date-fns (date utilities)</technology>
    <technology>Fuse.js (client-side search)</technology>
    <technology>Lucide React (icons)</technology>
    <technology>Sonner (toast notifications)</technology>
    <technology>Vitest (testing)</technology>
    <technology>Chromatic (visual testing)</technology>
    <technology>Mintlify (documentation)</technology>
  </technology_stack>

  <core_capabilities>
    <capability>Multi-tenant architecture with tenant-scoped data isolation via Clerk organizations</capability>
    <capability>Real-time task state synchronization using Ably pub/sub with outbox pattern</capability>
    <capability>Mobile-first UI with large touch targets and tap-first interactions</capability>
    <capability>Task claiming, completion, and un-claiming with automatic time tracking</capability>
    <capability>Task list organization by urgency, event, station, or status with filtering</capability>
    <capability>Recipe reference access from task details with scaled quantity display</capability>
    <capability>Method reference with video playback for technique guidance</capability>
    <capability>Role-based access control (owner, admin, manager, staff)</capability>
    <capability>Bulk task combining with AI-powered detection and manual override</capability>
    <capability>Prep list import from CSV, PDF, images, and markdown documents</capability>
    <capability>Staff proficiency and certification tracking with weighted leveling system</capability>
    <capability>Comment system for task clarification with answered/unanswered indicators</capability>
    <capability>Do not complete until date restrictions with manager override</capability>
    <capability>Label information display for food identification and tracking</capability>
    <capability>Employee information and real-time time tracking dashboard</capability>
    <capability>Event management with prep tasks and dish linkage</capability>
    <capability>Immutable recipe versioning with locked versions for prep tasks</capability>
    <capability>Kitchen production board with station-based task organization</capability>
  </core_capabilities>

  <implemented_features>
    <feature>
      <name>Multi-tenant data architecture</name>
      <description>Prisma schema with tenant-scoped tables across multiple schemas (public, core, platform, tenant_*). All queries require tenant_id filtering with no cross-tenant data access.</description>
      <file_locations>
        <location>packages/database/prisma/schema.prisma</location>
        <location>apps/app/app/lib/tenant.ts</location>
      </file_locations>
    </feature>
    <feature>
      <name>Kitchen task data model</name>
      <description>KitchenTask, KitchenTaskClaim, and KitchenTaskProgress models with status (open, in_progress, done, canceled), priority (low, medium, high, urgent), assignment tracking, and progress logging.</description>
      <file_locations>
        <location>packages/database/prisma/schema.prisma</location>
      </file_locations>
    </feature>
    <feature>
      <name>Real-time infrastructure</name>
      <description>Ably-based pub/sub with outbox pattern for event publishing. OutboxEvent model tracks pending/published/failed events for reliable delivery.</description>
      <file_locations>
        <location>apps/api/app/ably/auth/route.ts</location>
        <location>apps/api/app/outbox/publish/route.ts</location>
      </file_locations>
    </feature>
    <feature>
      <name>Authentication and authorization</name>
      <description>Clerk integration for user authentication with organization-based multi-tenancy. UserRole enum supports owner, admin, manager, and staff roles.</description>
      <file_locations>
        <location>packages/auth</location>
        <location>packages/database/prisma/schema.prisma</location>
      </file_locations>
    </feature>
    <feature>
      <name>Kitchen production board UI</name>
      <description>Static mockup of production board with order queue, prep station, and hot line columns. Station status sidebar with staff tracking and shift metrics.</description>
      <file_locations>
        <location>apps/app/app/(authenticated)/kitchen/page.tsx</location>
      </file_locations>
    </feature>
    <feature>
      <name>Event management</name>
      <description>Event model with tenant scoping, event number, title, date, guest count, status, venue information, and tags. Supports confirmed, tentative, cancelled, completed, and postponed statuses.</description>
      <file_locations>
        <location>packages/database/prisma/schema.prisma</location>
        <location>apps/app/app/(authenticated)/events/[eventId]/page.tsx</location>
      </file_locations>
    </feature>
    <feature>
      <name>Event import system</name>
      <description>Import events from CSV, PDF, and image sources. Creates events, dishes, recipes, and prep tasks automatically. Supports prep list and dish list CSV formats.</description>
      <file_locations>
        <location>apps/app/app/(authenticated)/events/import/page.tsx</location>
        <location>apps/app/app/(authenticated)/events/importer.ts</location>
      </file_locations>
    </feature>
    <feature>
      <name>Recipe and ingredient contracts</name>
      <description>Comprehensive data model for recipes, recipe versions, recipe ingredients, recipe steps, dishes, and ingredients. Supports immutable versioning with locked versions for prep task binding.</description>
      <file_locations>
        <location>apps/docs/internal/recipes-ingredients-contract.mdx</location>
      </file_locations>
    </feature>
    <feature>
      <name>Design system</name>
      <description>Radix UI-based component library with Tailwind CSS styling. Includes form controls, buttons, inputs, and Mangia brand theming with custom color palette.</description>
      <file_locations>
        <location>packages/design-system</location>
        <location>apps/docs/essentials/ui-guidelines.mdx</location>
      </file_locations>
    </feature>
    <feature>
      <name>Module placeholder pages</name>
      <description>Placeholder pages for Kitchen Tasks, Mobile Workflow, Prep Lists, Kitchen Schedule, Kitchen Team, Kitchen Inventory, and Kitchen Stations modules.</description>
      <file_locations>
        <location>apps/app/app/(authenticated)/kitchen/tasks/page.tsx</location>
        <location>apps/app/app/(authenticated)/kitchen/mobile/page.tsx</location>
        <location>apps/app/app/(authenticated)/kitchen/prep-lists/page.tsx</location>
      </file_locations>
    </feature>
  </implemented_features>

  <additional_requirements>
    <requirement>Node.js &gt;= 18 required</requirement>
    <requirement>Real-time updates must complete within 2 seconds for all authorized users</requirement>
    <requirement>Task claiming must complete in under 2 seconds from viewing task list</requirement>
    <requirement>Task completion must be visible to all team members within 2 seconds</requirement>
    <requirement>Support for teams of up to 50 concurrent users per company without performance degradation</requirement>
    <requirement>Network interruptions must not cause data loss - queue and sync on reconnection</requirement>
    <requirement>Method videos must handle network interruptions with resume or offline caching</requirement>
    <requirement>Time tracking must handle app backgrounding and device sleep correctly</requirement>
    <requirement>Concurrent task claims must be handled gracefully - only one user succeeds</requirement>
    <requirement>Tasks with missing data must display with appropriate warnings or placeholders</requirement>
    <requirement>Bulk combining must handle incompatible unit conversions gracefully</requirement>
    <requirement>Document imports must handle corrupted files with clear error messages</requirement>
  </additional_requirements>

  <development_guidelines>
    <guideline>Use pnpm exclusively for package management</guideline>
    <guideline>All queries must scope by tenant_id - no cross-tenant data access</guideline>
    <guideline>No direct database access from browsers - only apps/api and server actions may query the database</guideline>
    <guideline>Enforcement is server-side; no database RLS</guideline>
    <guideline>Use Ably events for real-time freshness - no client polling loops</guideline>
    <guideline>UI refresh on event should re-fetch once, not start intervals</guideline>
    <guideline>Never store binaries/blobs in Postgres - use Vercel Blob with signed URLs</guideline>
    <guideline>Prisma manages all migrations - raw SQL must be documented in migration notes</guideline>
    <guideline>Priority order for development: Recipes &gt; Kitchen tasks &gt; Events &gt; Scheduling</guideline>
    <guideline>Mobile UI must emphasize fast, tap-first interactions with large touch targets</guideline>
    <guideline>Mobile UI must minimize typing - use selection, toggles, and pre-filled options</guideline>
    <guideline>Mobile UI must present clear information hierarchy with color, icon, and text redundancy</guideline>
    <guideline>Domain logic for task state transitions, quantity scaling, and validation must be in shared packages</guideline>
    <guideline>Dates use six digits with periods (00.00.00) per brand guidelines</guideline>
    <guideline>Times written as &apos;5:00 pm&apos; format per brand guidelines</guideline>
  </development_guidelines>

  <implementation_roadmap>
    <phase>
      <name>Phase 1: MVP Core Task Management</name>
      <status>pending</status>
      <description>Mobile task list view with organized groupings and urgency indicators. Task claiming and completion functionality with real-time updates. Task details view with ingredients, quantities, instructions, and urgency. Recipe reference access from task details. Role-based access control for task visibility.</description>
    </phase>
    <phase>
      <name>Phase 2: Enhanced Task Features</name>
      <status>pending</status>
      <description>Method reference with video playback. Label information display. Employee information and automatic time tracking. Comment system for clarifications. Do not complete until date restrictions with manager override.</description>
    </phase>
    <phase>
      <name>Phase 3: Bulk Operations and Import</name>
      <status>pending</status>
      <description>Bulk combining logic with AI-powered detection and visual indicators. Manual task combining interface. Prep list import from pictures, CSV, markdown, and PDF with auto-creation and review capability.</description>
    </phase>
    <phase>
      <name>Phase 4: Staff Management</name>
      <status>pending</status>
      <description>Staff proficiency and certification tracking. Weighted leveling system based on completions, complexity, certifications, and seniority. Task qualification indicators based on staff proficiencies.</description>
    </phase>
  </implementation_roadmap>
</project_specification>