// @generated
// Generated by Capsule-Pro Manifest Generator v0.1.0
// DO NOT EDIT - Changes will be overwritten
// Source manifest: C:\Projects\capsule-pro\packages\kitchen-ops\manifests\recipe-rules.manifest
// Generator: packages/manifest/src/generators/capsule-pro.ts
//
// Escape hatch: Create a manual route in a sibling directory and import
// the generated handler as a helper function.
//
// Provenance:
//   Generated At: 2026-02-07T04:00:33.291Z

import { auth } from "@repo/auth/server";
import { database } from "@repo/database";
import { createRecipeRuntime, type KitchenOpsContext } from "@repo/kitchen-ops";
import { createPrismaStoreProvider } from "@repo/kitchen-ops/prisma-store";
import {
  manifestErrorResponse,
  manifestSuccessResponse,
} from "@repo/kitchen-ops/route-helpers";
import { getTenantIdForOrg } from "@/app/lib/tenant";

/**
 * Generated route handler for Recipe
 *
 * Generated from: C:\Projects\capsule-pro\packages\kitchen-ops\manifests\recipe-rules.manifest
 *
 * This handler uses the Manifest runtime for:
 * - Entity creation with constraint validation
 * - Command execution with guard checking
 * - Automatic persistence through PrismaStore
 */

export async function GET(request: Request) {
  // 1. Auth check
  const { orgId, userId } = await auth();
  if (!orgId) {
    return manifestErrorResponse(new Error("Unauthorized"), 401);
  }

  // 2. Tenant resolution
  const tenantId = await getTenantIdForOrg(orgId);

  // 3. Get current user
  const currentUser = await database.user.findFirst({
    where: {
      AND: [{ tenantId }, { authUserId: userId ?? "" }],
    },
  });

  if (!currentUser) {
    return manifestErrorResponse(new Error("User not found"), 400);
  }

  // 4. Create runtime context
  const runtimeContext: KitchenOpsContext = {
    tenantId,
    userId: currentUser.id,
    userRole: currentUser.role,
    storeProvider: createPrismaStoreProvider(database, tenantId),
  };

  // 5. Create runtime
  const runtime = await createRecipeRuntime(runtimeContext);

  // 6. Execute operation
  try {
    // List all Recipe entities
    const items = await runtime.getAllInstances("Recipe");
    return manifestSuccessResponse({ recipes: items });
  } catch (error) {
    return manifestErrorResponse(error instanceof Error ? error : new Error(String(error)));
  }
}
