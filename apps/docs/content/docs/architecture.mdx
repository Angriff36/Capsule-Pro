---
title: Architecture
description: Current and intended tech stack, systems, and third-party services.
---

This document is the source of truth for the current and intended tech stack,
core systems, and third-party services. The app is not production; if anything
seems wrong, verify in code before relying on it.

## Guiding Principles
- Multi-tenant by default: every query scopes by `tenant_id`.
- Enforcement: no DB RLS; all access is server-side and requires tenant context
  derived from Clerk orgs (see tenant helpers).
- No direct DB access from browsers; only `apps/api` and server actions may query
  the database.
- All systems connected: data created in one module must surface everywhere.
- Priority order: Recipes > Kitchen tasks -> Events -> Scheduling.
- Use pnpm only.

## Monorepo Overview
Tooling: Turbo + pnpm, Next.js 16, React 19, TypeScript.

### Apps
- `apps/app`: Primary product UI (Next.js). Tenant-scoped workflows.
- `apps/api`: API and worker endpoints (Next.js). Webhooks + outbox publisher.
- `apps/web`: Marketing/site app (Next.js + Basehub CMS).
- `apps/docs`: Mintlify docs (local port 2224).
- `apps/email`: React Email dev/build (templates live in `packages/email`).
- `apps/storybook`: UI component workshop + Chromatic.
- `apps/studio`: Prisma Studio (DB inspection).

### Shared Packages (high-level)
- `packages/database`: Prisma client + Neon adapter.
- `packages/auth`: Clerk auth integration.
- `packages/observability`: Sentry + Logtail wiring.
- `packages/analytics`: PostHog + Vercel Analytics.
- `packages/notifications`: Knock (in-app/email notifications).
- `packages/payments`: Stripe.
- `packages/collaboration`: Liveblocks.
- `packages/storage`: Vercel Blob.
- `packages/rate-limit`: Upstash Redis rate limiting.
- `packages/security`: Arcjet + Nosecone.
- `packages/webhooks`: Svix.
- `packages/cms`: Basehub client helpers.
- `packages/ai`: AI SDK + OpenAI provider.
- `packages/design-system`: Radix UI + Tailwind CSS + shared components.
- `packages/feature-flags`: Vercel Toolbar + flags.
- `packages/internationalization`: next-international.
- `packages/seo`: schema-dts + helpers.

## Data Layer
- DB: Neon (serverless Postgres).
- ORM: Prisma 7 with Neon adapter.
- Multi-schema model: `public`, `core`, `platform`, and `tenant_*` schemas.
  Schema names group domains; they are not per-tenant databases. All tenant
  tables still include `tenant_id`.
- Supabase: directory exists but is not part of the stack (no Supabase RLS).

## DB Cost Guardrails
- DB must be allowed to idle; no background query drizzle.
- Neon sleeps after ~5 minutes with no active queries.
- Never store binaries/blobs in Postgres; use object storage + signed URLs.

## Prisma Migrations
- Prisma manages schema and migrations for all models declared in
  `packages/database/prisma/schema.prisma`.
- Any raw SQL outside Prisma must be documented in migration notes.
- Prisma models declare `@@schema`; raw SQL must qualify schema names explicitly.

## Auth and Tenant Model
- Auth provider: Clerk.
- Tenants map to Clerk orgs; tenant IDs are required for all data access.
- Tenant helpers: `apps/app/app/lib/tenant.ts`.

## Tenant Helpers
Tenant context is resolved here:
- `apps/app/app/lib/tenant.ts`

## Realtime
- Transport: Ably.
- Pattern: outbox table + publisher endpoint.
- Ably auth: `apps/api/app/ably/auth/route.ts`.
- Outbox publish: `apps/api/app/outbox/publish/route.ts` (Bearer token required).
- Caller boundary: internal worker/cron only; never expose this endpoint publicly.

## Realtime Guardrails
- No client polling loops for freshness; Ably events are the freshness mechanism.
- UI refresh on event should re-fetch once, not start intervals.
- Health checks must not hit the database continuously.

## Realtime Known Issues

### "Connection closed" Runtime Error

**Symptoms:**
- `Runtime Error: Connection closed` in production-board-realtime.tsx or similar realtime components
- Occurs when navigating between pages or when components re-mount

**Root Cause:**
Calling `client.close()` in React component cleanup (`useEffect` return) closes the shared Ably connection. When other components (or the same component re-mounting) try to use the connection, it's already closed.

**Fix:**
Never call `client.close()` in component cleanup. Only unsubscribe from channels:

```typescript
// ✅ Correct - only clean up channels
return () => {
  channel.unsubscribe(handleMessage);
  // Don't close the client here
};

// ❌ Wrong - closes shared connection
return () => {
  channel.unsubscribe(handleMessage);
  client.close(); // Causes "Connection closed" errors
};
```

**Affected files (fixed):**
- `apps/app/app/(authenticated)/kitchen/production-board-realtime.tsx`
- `apps/app/app/(authenticated)/kitchen/recipes/recipes-realtime.tsx`
- `apps/app/app/(authenticated)/scheduling/scheduling-realtime.tsx`

**Explanation:**
- Multiple realtime components may share the same Ably connection
- Connection lifecycle should be managed at the application level, not per-component
- Closing and recreating connections wastes resources and causes errors

### CORS Error on Ably Auth Endpoint

**Symptoms:**
- `Access to fetch at 'http://localhost:2223/ably/auth' from origin 'http://localhost:2221' has been blocked by CORS policy`
- `No 'Access-Control-Allow-Origin' header is present on the requested resource`
- Occurs when app (port 2221) calls API (port 2223) for Ably token authentication

**Root Cause:**
Cross-origin requests from browser require CORS headers on the response. The `/ably/auth` endpoint wasn't returning `Access-Control-Allow-Origin` headers.

**Fix:**
Add CORS headers to the `/ably/auth` route:

```typescript
// In apps/api/app/ably/auth/route.ts
function corsHeaders(request: Request) {
  const allowedOrigins = [
    "http://localhost:2221",
    "http://localhost:2222",
    "http://localhost:3000",
  ];
  const origin = request.headers.get("origin");
  const allowedOrigin = origin && allowedOrigins.includes(origin)
    ? origin
    : allowedOrigins[0];

  return {
    "Access-Control-Allow-Origin": allowedOrigin,
    "Access-Control-Allow-Methods": "POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
    "Access-Control-Allow-Credentials": "true",
  };
}

// Add OPTIONS handler for preflight requests
export async function OPTIONS(request: Request) {
  return new NextResponse(null, { status: 204, headers: corsHeaders(request) });
}

// Include CORS headers on all responses
return NextResponse.json(tokenRequest, { headers: corsHeaders(request) });
```

**Also required:** Add `credentials: "include"` to client-side fetch calls so Clerk cookies are sent:

```typescript
const response = await fetch(`${apiBaseUrl}/ably/auth`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  credentials: "include", // Required for Clerk cookies
  body: JSON.stringify({ tenantId }),
});
```

**Affected files (fixed):**
- `apps/api/app/ably/auth/route.ts` - Added CORS headers
- `apps/app/app/(authenticated)/kitchen/production-board-realtime.tsx` - Added credentials: "include"
- `apps/app/app/(authenticated)/kitchen/recipes/recipes-realtime.tsx` - Added credentials: "include"
- `apps/app/app/(authenticated)/scheduling/scheduling-realtime.tsx` - Added credentials: "include"

**Environment variable:**
Set `ABLY_AUTH_CORS_ORIGINS` to configure allowed origins (comma-separated):
```
ABLY_AUTH_CORS_ORIGINS="http://localhost:2221,http://localhost:2222,http://localhost:3000"
```

## Observability
- Error reporting: Sentry.
- Logging: Logtail.

## Third-Party Services (Current + Intended)
| Service | Purpose | Location |
|---|---|---|
| Clerk | Auth, orgs, user management | `packages/auth`, `apps/app`, `apps/api` |
| Neon | Postgres database | `packages/database` |
| Prisma | ORM + schema management | `packages/database` |
| Ably | Realtime pub/sub | `apps/api`, `apps/app` |
| Stripe | Payments + webhooks | `packages/payments`, `apps/api` |
| Svix | Webhook handling | `packages/webhooks`, `apps/api` |
| Knock | Notifications | `packages/notifications` |
| Liveblocks | Collaboration | `packages/collaboration` |
| Sentry | Error monitoring | `packages/observability`, `apps/*` |
| Logtail | Log aggregation | `packages/observability` |
| PostHog | Product analytics | `packages/analytics` |
| Vercel Analytics | Web analytics | `packages/analytics` |
| Vercel Blob | File storage | `packages/storage` |
| Upstash Redis | Rate limiting | `packages/rate-limit` |
| Arcjet | Security (bot/abuse) | `packages/security`, `apps/web` |
| Nosecone | Security headers | `packages/security` |
| Basehub | CMS for web app | `packages/cms`, `apps/web` |
| Resend | Transactional email | `packages/email` |
| React Email | Email templates | `apps/email`, `packages/email` |
| Mintlify | Documentation site | `apps/docs` |
| Chromatic | Storybook visual review | `apps/storybook` |
| OpenAI (via AI SDK) | AI features (planned/optional) | `packages/ai` |

## Intended/Planned Areas (may be partial)
- Feature flags framework in place; enable per feature as needed.
- AI feature package exists; integrate where product needs AI flows.
- Collaboration, notifications, and analytics packages are available; wire as
  requirements expand.
- Menu builder and costing analysis are noted as future work in domain docs.

## Module Interconnectivity
All modules are expected to interoperate:
- CRM/Event data must reflect in kitchen and scheduling.
- Recipes are the core source for kitchen tasks and event menus.
- Realtime updates are tenant-scoped and use the Ably outbox pipeline.